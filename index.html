<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jessie Math - 面積互動大挑戰</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700;900&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --bg:#f4f6fb; --card:#fff; --shadow:0 10px 30px rgba(2,8,23,.08);
      --radius:18px; --safe:16px;
      --brand:#5f73ff; --brand2:#f7b3c2; --accent:#FFD700;
      --good:#16a34a; --bad:#dc2626;

      --font-sans: "Plus Jakarta Sans","Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
      --font-display:"Fredoka","Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:var(--font-sans);
      background:
        radial-gradient(900px 420px at 10% -10%, rgba(95,115,255,.18), transparent 60%),
        radial-gradient(700px 420px at 95% 0%, rgba(247,179,194,.25), transparent 55%),
        linear-gradient(180deg,#fff,var(--bg));
      min-height:100vh;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(226,232,240,.7);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto;
      padding:12px var(--safe);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:180px;}
    .logo{
      width:44px;height:44px;border-radius:999px;background:var(--accent);
      display:grid;place-items:center;
      box-shadow:0 10px 20px rgba(2,8,23,.10);
      flex:0 0 auto;
    }
    .logo img{
      width:30px;height:30px;object-fit:contain;display:block;
      filter:drop-shadow(0 4px 10px rgba(2,8,23,.12));
    }
    .brand-title{
      font-family:var(--font-display);
      font-weight:800;font-size:22px;letter-spacing:.2px
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      appearance:none;border:1px solid #dbe4ff;background:#fff;color:#1f2937;
      padding:10px 12px;border-radius:999px;font-weight:800;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;text-decoration:none;
      box-shadow:0 8px 18px rgba(2,8,23,.06);
      user-select:none;
    }
    .pill.primary{
      border-color: rgba(95,115,255,.35);
      background: linear-gradient(180deg, rgba(95,115,255,.12), rgba(255,255,255,.85));
      color:#1e1b4b;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px var(--safe) 28px;}
    .page{display:none;}
    .page.active{display:block;}
    .panel{
      background:var(--card);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    h1,h2,h3,p{margin:0}
    h1,h2,h3{font-family:var(--font-display)}
    .muted{color:var(--muted);font-weight:800;line-height:1.65}
    .chipRow{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;background:#f8fafc;border:1px solid #e2e8f0;
      font-weight:900;font-size:13px;
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{
      appearance:none;border:1px solid rgba(226,232,240,.9);background:#fff;color:var(--ink);
      padding:12px 12px;border-radius:14px;font-weight:900;cursor:pointer;
      display:inline-flex;gap:10px;align-items:center;
      box-shadow:0 10px 24px rgba(2,8,23,.08);
      transition:transform .12s ease, box-shadow .12s ease;
      user-select:none;
      font-family:var(--font-sans);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(2,8,23,.12)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn.brand{
      border-color:rgba(95,115,255,.28);
      background:linear-gradient(180deg, rgba(95,115,255,.10), rgba(255,255,255,.92));
      color:#1e1b4b;
    }
    .btn.danger{
      border-color:rgba(220,38,38,.25);
      background:rgba(220,38,38,.08);
      color:#7f1d1d;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none;}
    input{
      width:100%;
      border:1px solid rgba(226,232,240,.9);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      font-weight:800;
      outline:none;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      font-family:var(--font-sans);
    }
    input:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(95,115,255,.14), 0 12px 26px rgba(2,8,23,.08)
    }

    .menuGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media(max-width:900px){.menuGrid{grid-template-columns:1fr}}

    .levels{display:grid;grid-template-columns:1fr;gap:12px;}
    .card{
      border:1px solid rgba(226,232,240,.9);
      border-radius:16px;
      background:
        radial-gradient(240px 120px at 20% 0%, rgba(95,115,255,.16), transparent 60%),
        radial-gradient(240px 120px at 100% 0%, rgba(247,179,194,.20), transparent 60%),
        #fff;
      box-shadow:var(--shadow);
      padding:14px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      min-height:118px;
    }
    .card:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(2,8,23,.12);border-color:#c7d2fe;}
    .card.active{outline:3px solid rgba(95,115,255,.35); outline-offset:2px;}
    .lvlTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(95,115,255,.25);
      background: rgba(95,115,255,.10);
      color:#1e1b4b;
      white-space:nowrap;
      font-family:var(--font-display);
    }
    .hint{margin-top:8px;color:var(--muted);font-weight:800;font-size:13px;line-height:1.45}

    .diffRow{display:flex;gap:10px;flex-wrap:wrap;}
    .radio{
      flex:1 1 160px;
      border:1px solid rgba(226,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      cursor:pointer;
      user-select:none;
    }
    .radio:hover{border-color:#c7d2fe;}
    .radio input{margin-top:3px;}
    .dtitle{margin:0;font-weight:900;font-family:var(--font-display)}
    .dsub{margin:4px 0 0;color:var(--muted);font-weight:800;font-size:12px;line-height:1.4}

    .board{margin-top:12px;border:1px solid rgba(226,232,240,.9);border-radius:16px;overflow:hidden;background:#fff;}
    .boardHead{
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(95,115,255,.10), rgba(255,255,255,.95));
      border-bottom:1px solid rgba(226,232,240,.9);
      font-weight:900;
      font-family:var(--font-display);
    }
    .list{list-style:none;margin:0;padding:0;max-height:280px;overflow:auto;}
    .list li{
      display:flex;justify-content:space-between;gap:10px;
      padding:10px 12px;border-bottom:1px dashed rgba(226,232,240,.9);
      font-weight:900;
    }
    .list li:last-child{border-bottom:none;}
    .left{display:flex;gap:10px;align-items:center;}
    .no{
      width:26px;height:26px;border-radius:999px;display:grid;place-items:center;
      background: rgba(247,179,194,.25);border:1px solid rgba(247,179,194,.5);font-weight:900;
      font-family:var(--font-display);
    }
    .meta{color:var(--muted);font-weight:800;font-size:12px;margin-left:6px;}

    .hud{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      margin-bottom:14px;
    }
    .stat{
      border:1px solid rgba(226,232,240,.9);
      background:#fff;border-radius:14px;padding:10px 12px;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      display:flex;gap:10px;align-items:center;font-weight:900;
    }
    .stat small{display:block;color:var(--muted);font-weight:800;font-size:12px}
    .stat .val{font-size:18px;line-height:1;font-family:var(--font-display)}
    .chip2{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background:#f8fafc;border:1px solid #e2e8f0;font-weight:900;font-size:13px
    }

    .gameGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    @media(max-width:900px){.gameGrid{grid-template-columns:1fr}}
    .qTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:10px;}
    .qTitle{margin:0;font-size:20px;font-weight:900;font-family:var(--font-display)}
    .qSubtitle{margin:8px 0 0;color:var(--muted);font-weight:800;line-height:1.65;font-size:15.5px}
    .tagRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tag{
      font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;
      background: rgba(247,179,194,.22); border:1px solid rgba(247,179,194,.5);
      white-space:nowrap;
    }
    .tag.blue{background: rgba(95,115,255,.12); border-color: rgba(95,115,255,.25); color:#1e1b4b;}

    .playArea{
      border:1px solid rgba(226,232,240,.9);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
    }
    .playAreaInner{padding:12px;display:grid;gap:10px;}
    .svgWrap{width:100%;display:grid;place-items:center;padding:6px 0;}
    #stage{
      width:100%;
      max-width:740px;
      position:relative;
      aspect-ratio: 700 / 360;
    }
    #drawCanvas{position:absolute;inset:0;width:100%;height:100%;touch-action:none;}

    .formula{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:900;background: rgba(15,23,42,.04);
      border:1px solid rgba(226,232,240,.9);
      border-radius:14px; padding:10px 12px; overflow:auto;
    }
    .answerRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .answerRow input{flex:1 1 180px;}
    .feedback{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(226,232,240,.9);
      background:#fff;font-weight:900;display:none;
    }
    .feedback.show{display:block}
    .feedback.good{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.10);color:#064e3b}
    .feedback.bad{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.10);color:#7f1d1d}

    .drawHint{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(226,232,240,.9);
      background:#fff;box-shadow:0 10px 24px rgba(2,8,23,.06);
      font-weight:900;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .drawHint b{color:#1e1b4b;font-family:var(--font-display)}
    .smallBtn{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(226,232,240,.9);
      background:#fff;font-weight:900;cursor:pointer;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      display:inline-flex;gap:10px;align-items:center;justify-content:center;
      user-select:none;
      font-family:var(--font-sans);
    }
    .smallBtn.brand{border-color:rgba(95,115,255,.25);background:rgba(95,115,255,.10);color:#1e1b4b;}

    .hint-line{ position:absolute; pointer-events:none; border-radius:10px; opacity:.92; z-index:5; filter: blur(.2px); }
    .hint-bad{ background:rgba(220,38,38,.32); }
    .hint-warn{ background:rgba(255,193,7,.28); box-shadow:0 0 16px rgba(255,193,7,.45); }
    .hint-good{ background:rgba(22,163,74,.28); box-shadow:0 0 18px rgba(22,163,74,.65); }

    .lv2Info{
      display:none; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:12px 12px; border-radius:16px; border:1px solid rgba(226,232,240,.9);
      background:#fff; box-shadow:0 10px 24px rgba(2,8,23,.06);
    }
    .lv2Info.show{ display:flex; }
    .kvRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .kv{
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(226,232,240,.9);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(95,115,255,.06));
      font-weight:900;
    }
    .kv .label{color:var(--muted);font-weight:800;font-size:13px}
    .kv .num{font-size:20px; letter-spacing:.3px;font-family:var(--font-display)}
    .kv.area{border-color:rgba(247,179,194,.55); background:linear-gradient(180deg, rgba(247,179,194,.22), rgba(255,255,255,.95));}
    .kv.base{border-color:rgba(95,115,255,.35); background:linear-gradient(180deg, rgba(95,115,255,.14), rgba(255,255,255,.95));}
    .lv2MiniTip{ color:var(--muted); font-weight:800; font-size:13px; line-height:1.5; }
    .lv2Hud{
      display:none; gap:10px;flex-wrap:wrap;align-items:center;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(226,232,240,.9);
      background:#fff;box-shadow:0 10px 24px rgba(2,8,23,.06); font-weight:900;
    }
    .lv2Hud .pillVal{
      padding:6px 10px;border-radius:999px;
      background:rgba(95,115,255,.10); border:1px solid rgba(95,115,255,.25);
      color:#1e1b4b; font-weight:900; white-space:nowrap; font-size:16px;
      font-family:var(--font-display);
    }

    .sideCard h3{margin:0 0 10px;font-size:16px;font-weight:900;font-family:var(--font-display)}
    .mini{display:grid;gap:10px}
    .mini .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;}
    .stars{font-size:18px;letter-spacing:1px;font-family:var(--font-display)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btnSmall{
      flex:1 1 140px;
      border-radius:14px;padding:12px 12px;font-weight:900;
      border:1px solid rgba(226,232,240,.9);background:#fff;cursor:pointer;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      display:inline-flex;gap:10px;align-items:center;justify-content:center;
      user-select:none;
      font-family:var(--font-sans);
    }
    .btnSmall.brand{border-color:rgba(95,115,255,.25);background:rgba(95,115,255,.10);color:#1e1b4b}
    .btnSmall.danger{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.08);color:#7f1d1d}

    .mask{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(255,255,255,.45); backdrop-filter: blur(8px);
      z-index:90; padding:16px;
    }
    .mask.show{display:flex}
    .modal{
      background:#fff;border:1px solid rgba(226,232,240,.9);
      border-radius:20px; padding:18px 16px;width:min(460px,92vw);
      box-shadow:0 30px 80px rgba(2,8,23,.22);
      text-align:center;
    }
    .modal .big{font-size:22px;font-weight:900;margin:0 0 6px;font-family:var(--font-display)}
    .modal .sub{margin:0;color:var(--muted);font-weight:800;line-height:1.6}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"><img src="JESSIEMATH-Q.png" alt="Jessie Math Q 版" /></div>
        <div class="brand-title">Jessie Math</div>
      </div>
      <nav class="nav" aria-label="導覽">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener">
          <i class="fa-solid fa-house"></i> 首頁
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener">
          <i class="fa-solid fa-gamepad"></i> 遊戲大廳
        </a>
        <a class="pill primary" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u8" target="_blank" rel="noopener">
          <i class="fa-solid fa-layer-group"></i> 五年級面積
        </a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section id="page-intro" class="page active">
      <div class="grid2">
        <div class="panel">
          <h1 style="font-size:26px;font-weight:900;letter-spacing:.2px;">
            五年級｜面積挑戰：把圖形拆成星光，再把答案寫成剛好 ✨
          </h1>
          <p class="muted" style="margin-top:8px;">
            三關練到：<b>畫出高</b>、<b>面積÷底找高（整數拖曳）</b>、<b>平/三/梯面積</b>。
          </p>
          <div class="chipRow">
            <span class="chip"><i class="fa-solid fa-stopwatch"></i> 60 秒一局</span>
            <span class="chip"><i class="fa-solid fa-square-plus"></i> 答對 +5 秒</span>
            <span class="chip"><i class="fa-solid fa-square-minus"></i> 答錯 -5 秒</span>
            <span class="chip"><i class="fa-solid fa-fire-flame-curved"></i> Combo 倍率</span>
            <span class="chip"><i class="fa-solid fa-star"></i> 星等評分</span>
          </div>

          <div class="panel" style="margin-top:14px;background: radial-gradient(260px 140px at 20% 0%, rgba(95,115,255,.16), transparent 60%), radial-gradient(260px 140px at 95% 0%, rgba(247,179,194,.18), transparent 60%), #fff;">
            <h3 style="font-size:16px;font-weight:900;"><i class="fa-solid fa-scroll"></i> 規則</h3>
            <p class="muted" style="margin-top:8px;font-size:13px;">
              ① 題目一直更新，答完立刻出下一題。<br>
              ② Combo 倍率：連續答對越多，分數越像火箭。<br>
              ③ <b>暫停</b>：時間停止、題目鎖住、有遮罩。<br>
              ④ <b>重新</b>：同關同難度重開（60 秒、分數歸零）。<br>
              ⑤ <b>回關卡主選單</b>：結束本局但<b>不寫入排行榜</b>（避免洗榜）。
            </p>
          </div>
        </div>

        <div class="panel">
          <h2 style="font-size:18px;font-weight:900;"><i class="fa-solid fa-user-pen"></i> 先輸入名字（強制）</h2>
          <p class="muted" style="margin-top:6px;font-size:13px;">排行榜只存在你的電腦裡（localStorage），不會上傳。</p>
          <div style="margin-top:12px;">
            <input id="nameInput" maxlength="12" placeholder="最多 12 字（例：Jessie）" />
          </div>
          <div class="btnRow">
            <button class="btn brand" id="btnIntroGo"><i class="fa-solid fa-rocket"></i> 進入選單</button>
            <button class="btn" id="btnIntroClear"><i class="fa-solid fa-eraser"></i> 清除名字</button>
          </div>
          <p class="muted" style="margin-top:10px;font-size:13px;">小彩蛋：名字越帥，手感越穩。</p>
        </div>
      </div>
    </section>

    <section id="page-menu" class="page">
      <div class="menuGrid">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:baseline;">
            <h2 style="font-size:20px;font-weight:900;">選擇關卡</h2>
            <div class="muted" style="font-size:13px;">先選關卡 → 選難度 → 開打</div>
          </div>

          <div class="levels" id="levelCards" style="margin-top:12px;">
            <div class="card" data-lv="1">
              <div class="lvlTop">
                <div style="font-weight:900;font-family:var(--font-display);">第一關｜畫出「高」</div>
                <span class="badge">即時提示</span>
              </div>
              <div class="hint">平行四邊形/三角形/梯形輪替：畫哪裡都行，只要「真的垂直」。</div>
            </div>

            <div class="card" data-lv="2">
              <div class="lvlTop">
                <div style="font-weight:900;font-family:var(--font-display);">第二關｜面積÷底找高（整數拖曳）</div>
                <span class="badge">大數字提示</span>
              </div>
              <div class="hint">只給面積＋底：先算出高（整數），再拖曳藍點拉到剛好。</div>
            </div>

            <div class="card" data-lv="3">
              <div class="lvlTop">
                <div style="font-weight:900;font-family:var(--font-display);">第三關｜三圖形面積輪替</div>
                <span class="badge">平 / 三 / 梯</span>
              </div>
              <div class="hint">計算：輸入面積（純算題感，像段考那種乾淨俐落）。</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:baseline;">
            <h2 style="font-size:20px;font-weight:900;">難度 / 速度</h2>
            <div class="muted" style="font-size:13px;">越快越狠（判定更嚴）</div>
          </div>

          <div class="diffRow" style="margin-top:12px;">
            <label class="radio">
              <input type="radio" name="diff" value="E" checked>
              <div>
                <p class="dtitle">悠遊（E）</p>
                <p class="dsub">出題慢｜數字小｜判定寬</p>
              </div>
            </label>

            <label class="radio">
              <input type="radio" name="diff" value="N">
              <div>
                <p class="dtitle">標準（N）</p>
                <p class="dsub">出題中｜數字中｜判定正常</p>
              </div>
            </label>

            <label class="radio">
              <input type="radio" name="diff" value="H">
              <div>
                <p class="dtitle">閃電（H）</p>
                <p class="dsub">出題快｜數字大｜判定更嚴</p>
              </div>
            </label>
          </div>

          <div class="board">
            <div class="boardHead">
              <span><i class="fa-solid fa-trophy"></i> 排行榜（Top 10）</span>
              <span class="muted" id="lbHint" style="font-size:13px;">先選關卡</span>
            </div>
            <ul class="list" id="lbList"></ul>
          </div>

          <div class="btnRow">
            <button class="btn brand" id="btnPlay" disabled><i class="fa-solid fa-rocket"></i> 開始遊戲</button>
            <button class="btn" id="btnBackIntro"><i class="fa-solid fa-arrow-left"></i> 回登入頁</button>
            <button class="btn" id="btnWipeLB"><i class="fa-solid fa-eraser"></i> 清空排行榜</button>
          </div>

          <div class="muted" style="margin-top:8px;font-size:13px;">玩家：<b id="menuPlayer">—</b></div>
        </div>
      </div>
    </section>

    <section id="page-game" class="page">
      <div class="panel">
        <div class="hud">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <div class="stat"><div><small>玩家</small><div class="val" id="hudName">—</div></div></div>
            <div class="stat"><div><small>時間</small><div class="val" id="hudTime">60</div></div><i class="fa-solid fa-stopwatch"></i></div>
            <div class="stat"><div><small>分數</small><div class="val" id="hudScore">0</div></div><i class="fa-solid fa-coins"></i></div>
            <div class="stat"><div><small>連擊</small><div class="val" id="hudCombo">0</div></div><i class="fa-solid fa-fire-flame-curved"></i></div>
            <div class="stat"><div><small>倍率</small><div class="val" id="hudMult">x1.0</div></div><i class="fa-solid fa-bolt"></i></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <span class="chip2" id="hudLevel"><i class="fa-solid fa-layer-group"></i> 關卡：—</span>
            <span class="chip2" id="hudDiff"><i class="fa-solid fa-gauge-high"></i> 難度：—</span>
          </div>
        </div>

        <div class="gameGrid">
          <section class="panel" style="box-shadow:none;">
            <div class="qTop">
              <div>
                <p class="qTitle" id="qTitle">題目載入中…</p>
                <p class="qSubtitle" id="qSubtitle">—</p>
              </div>
              <div class="tagRow">
                <span class="tag blue" id="tagGoal">任務：—</span>
                <span class="tag" id="tagTip">提示：—</span>
              </div>
            </div>

            <div class="playArea">
              <div class="playAreaInner">
                <div class="drawHint">
                  <i class="fa-solid fa-hand-pointer"></i>
                  <span>模式：<b id="modeName">—</b></span>
                  <span class="tag blue" id="modeText">—</span>

                  <span style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="smallBtn brand" id="btnShowAns"><i class="fa-solid fa-eye"></i> 顯示正解</button>
                    <button class="smallBtn" id="btnClearDraw"><i class="fa-solid fa-broom"></i> 清除畫線</button>
                  </span>
                </div>

                <div class="lv2Info" id="lv2Info">
                  <div class="kvRow">
                    <span class="kv area"><span class="label">面積</span><span class="num" id="lv2Area">—</span></span>
                    <span class="kv base"><span class="label">底</span><span class="num" id="lv2Base">—</span></span>
                  </div>
                  <div class="lv2MiniTip">算 <b>高 = 面積 ÷ 底</b>（整數），再拖曳藍點拉到「剛好」。</div>
                </div>

                <div class="lv2Hud" id="lv2Hud">
                  <span><i class="fa-solid fa-ruler-vertical"></i> 目前高度（整數吸附）</span>
                  <span class="pillVal" id="lv2CurH">—</span>
                  <span class="muted" style="font-size:13px;">（拉到剛好就過）</span>
                </div>

                <div class="svgWrap">
                  <div id="stage">
                    <div id="svgHost"></div>
                    <canvas id="drawCanvas"></canvas>
                  </div>
                </div>

                <div class="formula" id="workPad">列式區：—</div>

                <div class="answerRow" id="answerRow">
                  <input id="ansInput" inputmode="decimal" placeholder="輸入答案（可用小數）" autocomplete="off" />
                  <button class="btn brand" id="btnSubmit"><i class="fa-solid fa-check"></i> 送出</button>
                </div>

                <div class="feedback" id="feedback"></div>
              </div>
            </div>
          </section>

          <aside class="panel sideCard" style="box-shadow:none;">
            <h3>本局狀態</h3>
            <div class="mini">
              <div class="row"><span class="muted" style="font-size:13px;">正確 / 錯誤</span><span style="font-weight:900;"><span id="stCorrect">0</span> / <span id="stWrong">0</span></span></div>
              <div class="row"><span class="muted" style="font-size:13px;">星等預覽</span><span class="stars" id="stStars">☆☆☆</span></div>
              <div class="row"><span class="muted" style="font-size:13px;">一句提示</span><span style="font-weight:900;" id="stTip">先穩住，再爆擊。</span></div>
            </div>

            <div class="actions">
              <button class="btnSmall brand" id="btnPause"><i class="fa-solid fa-pause"></i> 暫停</button>
              <button class="btnSmall" id="btnRestart"><i class="fa-solid fa-rotate-right"></i> 重新</button>
              <button class="btnSmall danger" id="btnBackMenu"><i class="fa-solid fa-door-open"></i> 回關卡主選單</button>
            </div>

            <div class="board">
              <div class="boardHead">
                <span><i class="fa-solid fa-trophy"></i> 本關排行榜（Top 10）</span>
                <span class="tag blue" id="lbMiniKey">—</span>
              </div>
              <ul class="list" id="lbMini"></ul>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </main>

  <div class="mask" id="pauseMask">
    <div class="modal">
      <p class="big">暫停中 ⏸️</p>
      <p class="sub">時間停止、題目鎖住。你回來的時候，答案會更像詩。</p>
      <div class="btnRow" style="justify-content:center;margin-top:12px;">
        <button class="btn brand" id="btnResume"><i class="fa-solid fa-play"></i> 繼續</button>
      </div>
    </div>
  </div>

  <div class="mask" id="endMask">
    <div class="modal">
      <p class="big">時間到 ⏳</p>
      <p class="sub" id="endText">—</p>
      <div class="btnRow" style="justify-content:center;margin-top:12px;">
        <button class="btn brand" id="btnEndToMenu"><i class="fa-solid fa-layer-group"></i> 回關卡主選單</button>
        <button class="btn" id="btnEndAgain"><i class="fa-solid fa-rotate-right"></i> 再來一局</button>
      </div>
      <p class="muted" style="margin-top:8px;font-size:13px;">（本局已自動寫入排行榜 ✅）</p>
    </div>
  </div>

<script>
(() => {
  /* ========================= 小工具 ========================= */
  const $ = (s)=>document.querySelector(s);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
  const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const escapeHtml = (s)=>String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
  const pretty=(x)=>{
    const n = Math.round(Number(x)*10)/10;
    return Number.isInteger(n) ? String(n) : n.toFixed(1).replace(/\.0$/,"");
  };

  /* ========================= SPA 切頁 ========================= */
  const pages = ["page-intro","page-menu","page-game"];
  function goPage(id){
    pages.forEach(p=>document.getElementById(p)?.classList.remove("active"));
    document.getElementById(id)?.classList.add("active");
    window.scrollTo({top:0, behavior:"smooth"});
    if(id==="page-game"){
      requestAnimationFrame(()=>{
        resizeCanvasToStage();
        redrawOverlay();
      });
    }
  }

  /* ========================= 排行榜 ========================= */
  const LB_PREFIX="JM_AREA_ALL_V3_";
  const keyLB = (lv, df)=> `${LB_PREFIX}L${lv}_${df}`;
  const safeParse = (s, fallback)=>{ try{return JSON.parse(s);}catch(e){return fallback;} };
  const readLB = (lv, df)=> safeParse(localStorage.getItem(keyLB(lv, df))||"[]", []);
  const writeLB = (lv, df, list)=> localStorage.setItem(keyLB(lv, df), JSON.stringify(list.slice(0,10)));
  const clearAllLB = ()=>{ Object.keys(localStorage).forEach(k=>{ if(k.startsWith(LB_PREFIX)) localStorage.removeItem(k); }); };
  const starsFor = (score)=> score>=700?"★★★":score>=300?"★★☆":"★☆☆";

  /* ========================= 難度 ========================= */
  function diffCfg(df){
    if(df==="E") return { tick: 250, nextDelay: 650, angleTol: 18, edgeTol: 18, tolNum: 0.12, min:2, max:30 };
    if(df==="N") return { tick: 200, nextDelay: 520, angleTol: 12, edgeTol: 14, tolNum: 0.08, min:5, max:60 };
    return { tick: 150, nextDelay: 400, angleTol: 8, edgeTol: 12, tolNum: 0.06, min:10,max:99 };
  }
  const fmtDf = (df)=> ({E:"悠遊",N:"標準",H:"閃電"}[df]||"—");
  const fmtLv = (lv)=> ({
    1:"第一關｜畫出高",
    2:"第二關｜面積÷底找高（整數拖曳）",
    3:"第三關｜三圖形面積"
  }[lv]||"—");

  /* ========================= 狀態 ========================= */
  const state = {
    name:"",
    level:null,
    diff:"E",
    cfg: diffCfg("E"),
    running:false,
    paused:false,
    backToMenuNoSave:false,

    time:60,
    score:0,
    combo:0,
    correct:0,
    wrong:0,

    q:null,
    answer:null,
    mode:"NUM",
    showAns:false,

    stroke:[],
    strokeDone:false,

    dragUnit: 6,
    dragTargetInt: 0,
    dragCurInt: 0,

    timer:null
  };
  function multFor(combo){
    if(combo>=15) return 2.0;
    if(combo>=12) return 1.8;
    if(combo>=9) return 1.6;
    if(combo>=6) return 1.4;
    if(combo>=3) return 1.2;
    return 1.0;
  }

  /* ========================= Canvas（更穩版） ========================= */
  const canvas = $("#drawCanvas");
  const ctx = canvas?.getContext("2d");
  function getViewBox(){
    const q = state.q || {};
    return { W: q.W || 700, H: q.H || 360 };
  }
  function viewToPx(v){
    const stage = $("#stage");
    const {W,H} = getViewBox();
    if(!stage) return {x:0,y:0};
    const sx = stage.clientWidth / W;
    const sy = stage.clientHeight / H;
    return { x: v.x * sx, y: v.y * sy };
  }
  function pxToView(px){
    const stage = $("#stage");
    if(!stage) return {x:0,y:0};
    const r = stage.getBoundingClientRect();
    const {W,H} = getViewBox();
    return { x: (px.x / r.width) * W, y: (px.y / r.height) * H };
  }
  function pointerPosPx(e){
    const stage = $("#stage");
    const r = stage.getBoundingClientRect();
    return {x:(e.clientX - r.left), y:(e.clientY - r.top)};
  }

  function resizeCanvasToStage(){
    if(!canvas || !ctx) return;
    const stage = $("#stage");
    if(!stage) return;
    const rect = stage.getBoundingClientRect();
    if(rect.width <= 2 || rect.height <= 2) return;

    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    canvas.style.width = rect.width+"px";
    canvas.style.height = rect.height+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    redrawOverlay();
  }
  window.addEventListener("resize", ()=>{
    if($("#page-game")?.classList.contains("active")) resizeCanvasToStage();
  });

  function clearStroke(){
    state.stroke = [];
    state.strokeDone = false;
    redrawOverlay();
  }

  function redrawOverlay(){
    if(!canvas || !ctx) return;
    const stage = $("#stage");
    if(!stage) return;
    const w = stage.clientWidth;
    const h = stage.clientHeight;
    ctx.clearRect(0,0,w,h);

    if(state.stroke.length){
      ctx.lineWidth = 4;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "rgba(95,115,255,.95)";
      const p0 = viewToPx(state.stroke[0]);
      ctx.beginPath();
      ctx.moveTo(p0.x, p0.y);
      for(let i=1;i<state.stroke.length;i++){
        const p = viewToPx(state.stroke[i]);
        ctx.lineTo(p.x, p.y);
      }
      ctx.stroke();
    }

    if(state.showAns && state.q && state.q.solutionLine){
      const L = state.q.solutionLine;
      const a = viewToPx({x:L.x1, y:L.y1});
      const b = viewToPx({x:L.x2, y:L.y2});
      ctx.lineWidth = 4;
      ctx.setLineDash([8,6]);
      ctx.strokeStyle = "rgba(22,163,74,.95)";
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  /* ========================= 即時提示（LV1） ========================= */
  let hintEl = null;
  function removeLiveHint(){ if(hintEl){ hintEl.remove(); hintEl=null; } }
  function angleDeg(ax,ay,bx,by){
    const dx = bx-ax, dy = by-ay;
    return Math.atan2(dy, dx) * 180 / Math.PI;
  }
  function showLiveHintRect(cls, p1, p2){
    const stage = $("#stage");
    if(!stage) return;
    if(!hintEl){
      hintEl=document.createElement("div");
      hintEl.className="hint-line";
      stage.appendChild(hintEl);
    }
    hintEl.className="hint-line "+cls;

    const a = viewToPx(p1), b = viewToPx(p2);
    const x=Math.min(a.x,b.x);
    const y=Math.min(a.y,b.y);
    const ww=Math.abs(a.x-b.x)+6;
    const hh=Math.abs(a.y-b.y)+6;

    hintEl.style.left = (x-3)+"px";
    hintEl.style.top = (y-3)+"px";
    hintEl.style.width = Math.max(ww,8)+"px";
    hintEl.style.height = Math.max(hh,8)+"px";
  }
  function liveAngleHint(){
    if(state.level!==1 || state.mode!=="DRAW") return;
    if(state.stroke.length<2) { removeLiveHint(); return; }

    const L = state.stroke;
    const p1=L[0], p2=L[L.length-1];

    const ang = Math.abs(angleDeg(p1.x,p1.y,p2.x,p2.y));
    const angN = Math.min(Math.abs(ang), Math.abs(180-ang));
    const diff = Math.abs(90-angN);

    let cls="hint-bad", text="還不垂直";
    if(diff < state.cfg.angleTol*1.2){ cls="hint-warn"; text="快對了"; }
    if(diff < state.cfg.angleTol*0.65){ cls="hint-good"; text="就是這個！"; }

    showLiveHintRect(cls, p1, p2);
    $("#stTip").textContent = text;
  }

  /* ========================= UI ========================= */
  function setFeedback(text, type){
    const el = $("#feedback");
    if(!el) return;
    if(!text){
      el.className = "feedback";
      el.textContent = "";
      return;
    }
    el.className = "feedback show " + (type||"");
    el.textContent = text;
  }
  function addTime(delta){ state.time = clamp(state.time + delta, 0, 120); }

  // ✅ 只有第一關（DRAW）需要兩顆工具按鈕
  function updateUtilityButtons(){
    const showBtn = $("#btnShowAns");
    const clearBtn = $("#btnClearDraw");
    if(!showBtn || !clearBtn) return;

    const visible = (state.level===1 && state.mode==="DRAW");
    showBtn.style.display = visible ? "inline-flex" : "none";
    clearBtn.style.display = visible ? "inline-flex" : "none";

    if(!visible){
      state.showAns=false;
      removeLiveHint();
      redrawOverlay();
    }
  }

  function renderHUD(){
    $("#hudName").textContent = state.name || "—";
    $("#hudTime").textContent = state.time;
    $("#hudScore").textContent = state.score;
    $("#hudCombo").textContent = state.combo;
    $("#hudMult").textContent = "x"+multFor(state.combo).toFixed(1);
    $("#hudLevel").innerHTML = `<i class="fa-solid fa-layer-group"></i> ${fmtLv(state.level)}`;
    $("#hudDiff").innerHTML = `<i class="fa-solid fa-gauge-high"></i> 難度：${fmtDf(state.diff)}`;

    $("#stCorrect").textContent = state.correct;
    $("#stWrong").textContent = state.wrong;
    $("#stStars").textContent = starsFor(state.score);

    if(state.level===2){
      $("#lv2Hud").style.display="flex";
      $("#lv2CurH").textContent = String(state.dragCurInt || "—");
    }else{
      $("#lv2Hud").style.display="none";
    }
  }

  /* ========================= Leaderboard Render ========================= */
  let selectedLv=null;

  function renderMenuLB(){
    const lbList = $("#lbList");
    if(!lbList) return;

    if(!selectedLv){
      $("#lbHint").textContent="先選關卡";
      lbList.innerHTML = `<li><span class="left"><span class="no">—</span><span>尚未選擇</span></span><span class="muted">—</span></li>`;
      return;
    }
    const df = document.querySelector("input[name='diff']:checked")?.value || "E";
    $("#lbHint").textContent = `${fmtLv(selectedLv)}｜${fmtDf(df)}`;
    const list = readLB(selectedLv, df);
    if(!list.length){
      lbList.innerHTML = `<li><span class="left"><span class="no">—</span><span>目前還沒有紀錄</span></span><span class="muted">先衝一局</span></li>`;
      return;
    }
    lbList.innerHTML = list.map((it, idx)=>`
      <li>
        <span class="left">
          <span class="no">${idx+1}</span>
          <span>${escapeHtml(it.name)} <span class="meta">(${starsFor(it.score)})</span></span>
        </span>
        <span>${it.score}</span>
      </li>
    `).join("");
  }
  function renderMiniLB(){
    $("#lbMiniKey").textContent = `L${state.level}｜${fmtDf(state.diff)}`;
    const list = readLB(state.level, state.diff);
    const ul = $("#lbMini");
    if(!ul) return;
    if(!list.length){
      ul.innerHTML = `<li><span class="left"><span class="no">—</span><span>尚無紀錄</span></span><span class="muted">先當第一名</span></li>`;
      return;
    }
    ul.innerHTML = list.map((it, idx)=>`
      <li>
        <span class="left">
          <span class="no">${idx+1}</span>
          <span>${escapeHtml(it.name)} <span class="meta">(${starsFor(it.score)})</span></span>
        </span>
        <span>${it.score}</span>
      </li>
    `).join("");
  }
  function saveToLB(){
    const list = readLB(state.level, state.diff);
    list.push({name: state.name, score: state.score, t: Date.now()});
    list.sort((a,b)=>b.score-a.score || a.t-b.t);
    writeLB(state.level, state.diff, list);
  }

  /* ========================= 題庫：SVG + 幾何 ========================= */
  function svgWrap(inner, w=700, h=360){
    return `
    <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="xMidYMid meet" style="display:block;">
      <defs>
        <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(2,8,23,.20)"/>
        </filter>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
          <path d="M0,0 L6,3 L0,6 Z" fill="rgba(15,23,42,.55)"></path>
        </marker>
      </defs>
      ${inner}
    </svg>`;
  }
  function drawGrid(w=700,h=360){
    let lines = "";
    for(let x=50;x<=w-50;x+=50){
      lines += `<line x1="${x}" y1="40" x2="${x}" y2="${h-40}" stroke="rgba(15,23,42,.06)" stroke-width="2"/>`;
    }
    for(let y=40;y<=h-40;y+=50){
      lines += `<line x1="50" y1="${y}" x2="${w-50}" y2="${y}" stroke="rgba(15,23,42,.06)" stroke-width="2"/>`;
    }
    return `<g>${lines}</g>`;
  }
  function distPointToSegment(px,py,x1,y1,x2,y2){
    const vx=x2-x1, vy=y2-y1;
    const wx=px-x1, wy=py-y1;
    const c1 = vx*wx + vy*wy;
    if(c1<=0) return Math.hypot(px-x1, py-y1);
    const c2 = vx*vx + vy*vy;
    if(c2<=c1) return Math.hypot(px-x2, py-y2);
    const t = c1/c2;
    const projx = x1 + t*vx;
    const projy = y1 + t*vy;
    return Math.hypot(px-projx, py-projy);
  }

  /* ========================= 關卡出題 ========================= */
  function cfgNums(){ return {min:state.cfg.min, max:state.cfg.max}; }

  function updateAnswerRowUI(){
    const row = $("#answerRow");
    const input = $("#ansInput");
    const btn = $("#btnSubmit");
    if(!row || !input || !btn) return;

    if(state.level===2) $("#lv2Info")?.classList.add("show");
    else $("#lv2Info")?.classList.remove("show");

    if(state.mode==="DRAW"){
      row.style.display="flex";
      input.style.display="none";
      btn.innerHTML = `<i class="fa-solid fa-check"></i> 判定`;
      btn.disabled=false;
    }else if(state.mode==="DRAG"){
      row.style.display="flex";
      input.style.display="none";
      btn.innerHTML = `<i class="fa-solid fa-check"></i> 判定（高度要剛好）`;
      btn.disabled=false;
    }else{
      row.style.display="flex";
      input.style.display="block";
      btn.innerHTML = `<i class="fa-solid fa-check"></i> 送出`;
      btn.disabled=false;
    }

    updateUtilityButtons();
  }

  function buildQuestion(){
    state.showAns=false;
    clearStroke();
    removeLiveHint();
    const ansInput = $("#ansInput");
    if(ansInput){
      ansInput.value="";
      ansInput.disabled=false;
    }
    setFeedback("", "");

    if(state.level===1) buildLv1();
    else if(state.level===2) buildLv2();
    else buildLv3();

    updateAnswerRowUI();
    renderHUD();
    renderMiniLB();
    requestAnimationFrame(()=>resizeCanvasToStage());
  }

  /* ===== LV1：畫高 ===== */
  function buildLv1(){
    state.mode="DRAW";
    $("#modeName").textContent="畫線：畫出高";
    $("#modeText").textContent="即時提示陪你對準垂直";
    $("#tagGoal").textContent="任務：畫出「高」";
    $("#tagTip").textContent="提示：高要與底邊垂直";
    $("#workPad").textContent="列式區：這關不輸入數字，靠理解＋手感。";

    const type = pick(["para","tri","trap"]);
    const W=700,H=360;
    let base, topEdge, apex=null, polyPts=null, solutionLine=null, hintText="";

    if(type==="para"){
      const x1=170,y1=270, x2=520,y2=270;
      const skew=70, height=120;
      const A={x:x1,y:y1}, B={x:x2,y:y1}, C={x:x2+skew,y:y1-height}, D={x:x1+skew,y:y1-height};
      polyPts=[A,B,C,D];
      base={x1:A.x,y1:A.y,x2:B.x,y2:B.y};
      topEdge={x1:D.x,y1:D.y,x2:C.x,y2:C.y};
      const xm = (A.x+B.x)/2 + skew*0.2;
      solutionLine={x1:xm,y1:base.y1,x2:xm,y2:topEdge.y1};
      hintText="平行四邊形：高 = 底邊到上邊的垂直距離";
    }else if(type==="trap"){
      const A={x:160,y:280}, B={x:540,y:280}, topY=150, topL=250, topR=450;
      const C={x:topR,y:topY}, D={x:topL,y:topY};
      polyPts=[A,B,C,D];
      base={x1:A.x,y1:A.y,x2:B.x,y2:B.y};
      topEdge={x1:D.x,y1:D.y,x2:C.x,y2:C.y};
      const xm=(topL+topR)/2;
      solutionLine={x1:xm,y1:base.y1,x2:xm,y2:topY};
      hintText="梯形：高 = 兩底之間的垂直距離";
    }else{
      const A={x:200,y:280}, B={x:520,y:280}, V={x:410,y:140};
      polyPts=[A,B,V];
      base={x1:A.x,y1:A.y,x2:B.x,y2:B.y};
      apex=V;
      solutionLine={x1:V.x,y1:V.y,x2:V.x,y2:A.y};
      hintText="三角形：高 = 頂點到對邊的垂直距離";
    }

    state.q={W,H,type, base, topEdge, apex, polyPts, solutionLine};
    $("#qTitle").textContent = `第一關｜${hintText}`;
    $("#qSubtitle").textContent = "請在圖上「畫出高」。（答對 +5 秒，答錯 -5 秒）";

    const pts = polyPts.map(p=>`${p.x},${p.y}`).join(" ");
    const baseLine = `<line x1="${base.x1}" y1="${base.y1}" x2="${base.x2}" y2="${base.y2}" stroke="rgba(247,179,194,.95)" stroke-width="10" stroke-linecap="round"/>`;
    const extra = (type==="tri") ? `<circle cx="${apex.x}" cy="${apex.y}" r="7" fill="rgba(95,115,255,.85)"/>` : "";
    const inner = `
      ${drawGrid(W,H)}
      <polygon points="${pts}" fill="rgba(95,115,255,.10)" stroke="rgba(15,23,42,.55)" stroke-width="4" filter="url(#softShadow)"/>
      ${baseLine}
      ${extra}
      <text x="60" y="60" fill="rgba(15,23,42,.70)" font-size="18" font-weight="900">底邊（粉色粗線）</text>
    `;
    $("#svgHost").innerHTML = svgWrap(inner,W,H);
  }
  function judgeLv1(){
    if(!state.strokeDone || state.stroke.length<2) return {ok:false, msg:"請先畫出一條線（高）"};
    const L = state.stroke;
    const p1=L[0], p2=L[L.length-1];
    const {base, topEdge, apex, type} = state.q;

    const tolA = state.cfg.angleTol;
    const edgeTol = state.cfg.edgeTol;

    const bottom = (p1.y>p2.y) ? p1 : p2;
    const top = (p1.y>p2.y) ? p2 : p1;

    const ang = Math.abs(angleDeg(p1.x,p1.y,p2.x,p2.y));
    const angN = Math.min(Math.abs(ang), Math.abs(180-ang));
    const vertical = Math.abs(90 - angN) <= tolA;

    const dBase = distPointToSegment(bottom.x,bottom.y, base.x1,base.y1, base.x2,base.y2);
    const nearBase = dBase <= edgeTol;

    let nearTop=false;
    if(type==="tri"){
      nearTop = Math.hypot(top.x - apex.x, top.y - apex.y) <= (edgeTol+12);
    }else{
      const dTop = distPointToSegment(top.x,top.y, topEdge.x1,topEdge.y1, topEdge.x2,topEdge.y2);
      nearTop = dTop <= edgeTol;
    }

    if(vertical && nearBase && nearTop) return {ok:true, msg:"漂亮！這條線就是高 ✅"};
    let why=[];
    if(!vertical) why.push("要和底邊垂直");
    if(!nearBase) why.push("線要碰到底邊附近");
    if(!nearTop) why.push(type==="tri" ? "線要碰到頂點附近" : "線要碰到上邊附近");
    return {ok:false, msg:"差一點點："+why.join("、")+"。"};
  }

  /* ===== LV2：拖曳找高 ===== */
  let drag={active:false, offsetY:0};

  function setLv2HeightInt(hInt){
    const q = state.q;
    const h = clamp(Math.round(hInt), 1, q.maxHInt);
    state.dragCurInt = h;

    q.topY = q.baseY - (h * state.dragUnit);
    q.handle = {x:q.handleX, y:q.topY};
    q.solutionLine = {x1:q.handleX, y1:q.baseY, x2:q.handleX, y2:(q.baseY - (state.dragTargetInt * state.dragUnit))};
  }

  function buildLv2(){
    state.mode="DRAG";
    $("#modeName").textContent="拖曳：把高度拉到剛好（整數）";
    $("#modeText").textContent="吸附整數";
    $("#tagGoal").textContent="任務：面積÷底 找高";
    $("#tagTip").textContent="提示：高 = 面積 ÷ 底";
    $("#workPad").textContent="列式區：面積 = 底 × 高（所以 高 = 面積 ÷ 底）";

    const {min,max} = cfgNums();

    const b = randInt(Math.max(6,min+3), Math.min(30,max));
    const h = randInt(Math.max(4,min+2), Math.min(18, Math.max(8, Math.floor(max/2))));
    const area = b*h;
    state.dragTargetInt = h;

    const W=700,H=360;
    const baseY=285;
    const skew=70;
    const handleX=(200+520)/2 + skew*0.2;
    const maxHInt = 22;

    state.q={W,H, type:"para", b, h, area, baseY, topY:0, skew, handleX, handle:null, solutionLine:null, maxHInt};

    const startH = clamp(h + pick([-6,-5,-4,-3,-2,-1,1,2,3,4,5,6]), 1, maxHInt);
    setLv2HeightInt(startH);

    $("#lv2Area").textContent = area;
    $("#lv2Base").textContent = b;

    $("#qTitle").textContent = "第二關｜已知面積與底：拖曳出整數高度";
    $("#qSubtitle").innerHTML = `面積 <b>${area}</b>、底 <b>${b}</b>。先算 <b>高 = ${area} ÷ ${b}</b>，再拖曳藍點把高度拉到剛好。`;

    renderLv2();
  }

  function renderLv2(){
    const q=state.q;
    const W=q.W,H=q.H;
    const A={x:200,y:q.baseY}, B={x:520,y:q.baseY};
    const D={x:A.x+q.skew,y:q.topY}, C={x:B.x+q.skew,y:q.topY};
    const pts = [A,B,C,D].map(p=>`${p.x},${p.y}`).join(" ");
    q.handle = {x:q.handleX, y:q.topY};
    q.solutionLine = {x1:q.handleX, y1:q.baseY, x2:q.handleX, y2:(q.baseY - (state.dragTargetInt * state.dragUnit))};

    const bigLabel = (txt)=> `
      <g>
        <text x="60" y="70" fill="rgba(15,23,42,.78)" font-size="28" font-weight="900" letter-spacing=".5">${txt}</text>
        <text x="60" y="102" fill="rgba(100,116,139,.95)" font-size="18" font-weight="900">（先算出高，再把藍點拉到剛好）</text>
      </g>
    `;

    const inner = `
      ${bigLabel(`面積 = ${q.area}　底 = ${q.b}　高 = ？`)}
      <polygon points="${pts}" fill="rgba(95,115,255,.10)" stroke="rgba(15,23,42,.55)" stroke-width="4" filter="url(#softShadow)"/>
      <line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}" stroke="rgba(247,179,194,.95)" stroke-width="10" stroke-linecap="round"/>
      <circle cx="${q.handle.x}" cy="${q.handle.y}" r="10" fill="rgba(95,115,255,.90)"/>
    `;
    $("#svgHost").innerHTML = svgWrap(inner,W,H);

    $("#lv2CurH").textContent = String(state.dragCurInt);
    $("#lv2Hud").style.display="flex";

    requestAnimationFrame(()=>{ resizeCanvasToStage(); redrawOverlay(); });
  }

  function hitHandleLv2(pxV){
    const h = state.q?.handle;
    if(!h) return false;
    const d = Math.hypot(pxV.x - h.x, pxV.y - h.y);
    return d <= 18;
  }
  function applyLv2DragY(newY){
    const q=state.q;
    const minTop = q.baseY - (q.maxHInt * state.dragUnit);
    const maxTop = q.baseY - (1 * state.dragUnit);
    const y = clamp(newY, minTop, maxTop);
    const hFloat = (q.baseY - y) / state.dragUnit;
    const hInt = Math.round(hFloat);
    setLv2HeightInt(hInt);
    renderLv2();
  }
  function judgeLv2(){ return state.dragCurInt === state.dragTargetInt; }

  /* ===== LV3：計算面積（純算題） ===== */
  function scaleLen(n, nMin, nMax, pxMin, pxMax){
    if(nMax===nMin) return (pxMin+pxMax)/2;
    const t = (n - nMin) / (nMax - nMin);
    return pxMin + t * (pxMax - pxMin);
  }
  function buildLv3(){
    state.mode="NUM";
    $("#modeName").textContent="計算：輸入面積";
    $("#modeText").textContent="答完立刻出下一題";
    $("#tagGoal").textContent="任務：算面積";
    $("#tagTip").textContent="提示：選對公式再算";

    const type = pick(["para","tri","trap"]);

    const {min,max} = cfgNums();
    let b = randInt(Math.max(min+3, 6), Math.min(max, 50));
    let h = randInt(Math.max(min+3, 5), Math.min(max, 35));
    let a = randInt(Math.max(min+3, 4), Math.min(max, 40));
    let ans=0, formula="", subtitle="";

    if(type==="para"){
      ans=b*h; formula="面積 = 底 × 高"; subtitle=`底 ${b}，高 ${h}`;
    }else if(type==="tri"){
      ans=(b*h)/2;
      if(ans%1!==0 && state.diff!=="H"){ b*=2; ans=(b*h)/2; }
      formula="面積 = 底 × 高 ÷ 2"; subtitle=`底 ${b}，高 ${h}`;
    }else{
      if(a>=b) { const t=a; a=Math.max(4, b-randInt(2,12)); b=t+randInt(2,12); }
      ans=((a+b)/2)*h;
      if(ans%1!==0 && state.diff!=="H"){
        if(((a+b)%2)===1) a += 1;
        ans=((a+b)/2)*h;
      }
      formula="面積 = (上底 + 下底) × 高 ÷ 2";
      subtitle=`上底 ${a}，下底 ${b}，高 ${h}`;
    }

    const basePx = scaleLen(b, 4, Math.max(40, max), 240, 440);
    const heightPx = scaleLen(h, 4, Math.max(35, max), 90, 170);
    const topPx = (type==="trap") ? scaleLen(a, 4, Math.max(40, max), 180, 380) : null;

    state.answer=ans;
    state.q={W:700,H:360,type,a,b,h, geom:{basePx, heightPx, topPx}};

    $("#qTitle").textContent = `第三關｜${({para:"平行四邊形",tri:"三角形",trap:"梯形"}[type])} 面積`;
    $("#qSubtitle").textContent = `${subtitle}，求面積。（答對 +5 秒，答錯 -5 秒）`;
    $("#workPad").textContent = "列式區："+formula;
    $("#ansInput").placeholder="輸入面積（數字）";

    renderLv3();
  }
  function renderLv3(){
    const q=state.q;
    const W=q.W,H=q.H;
    let inner = "";

    const baseY = 285;
    const centerX = 365;

    const examHeader = (txt)=> `
      <g>
        <rect x="52" y="38" width="596" height="78" fill="rgba(255,255,255,.98)" stroke="rgba(226,232,240,.95)" stroke-width="2" rx="14"></rect>
        <text x="72" y="70" fill="rgba(15,23,42,.80)" font-size="22" font-weight="900">${txt}</text>
        <text x="72" y="98" fill="rgba(100,116,139,.95)" font-size="16" font-weight="900">（像段考：看數字、看圖形、選對公式就收工）</text>
      </g>
    `;

    const stroke = `stroke="rgba(15,23,42,.70)" stroke-width="4"`;
    const fill = `fill="rgba(95,115,255,.08)"`;

    if(q.type==="para"){
      const baseLen = q.geom.basePx;
      const height = q.geom.heightPx;
      const skew = 70;
      const x1 = centerX - baseLen/2;
      const x2 = centerX + baseLen/2;
      const A={x:x1,y:baseY}, B={x:x2,y:baseY};
      const D={x:A.x+skew,y:A.y-height}, C={x:B.x+skew,y:B.y-height};
      inner += `
        ${examHeader(`底 = ${q.b}　高 = ${q.h}`)}
        <polygon points="${A.x},${A.y} ${B.x},${B.y} ${C.x},${C.y} ${D.x},${D.y}" ${fill} ${stroke} filter="url(#softShadow)"/>
        <line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}" stroke="rgba(15,23,42,.62)" stroke-width="6" stroke-linecap="round"/>
      `;
    }
    if(q.type==="tri"){
      const baseLen = q.geom.basePx;
      const height = q.geom.heightPx;
      const x1 = centerX - baseLen/2;
      const x2 = centerX + baseLen/2;
      const A={x:x1,y:baseY}, B={x:x2,y:baseY}, V={x:centerX, y:baseY-height};
      inner += `
        ${examHeader(`底 = ${q.b}　高 = ${q.h}`)}
        <polygon points="${A.x},${A.y} ${B.x},${B.y} ${V.x},${V.y}" ${fill} ${stroke} filter="url(#softShadow)"/>
        <line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}" stroke="rgba(15,23,42,.62)" stroke-width="6" stroke-linecap="round"/>
      `;
    }
    if(q.type==="trap"){
      const bottomLen = q.geom.basePx;
      const topLen = q.geom.topPx;
      const height = q.geom.heightPx;
      const botL = centerX - bottomLen/2;
      const botR = centerX + bottomLen/2;
      const topY = baseY - height;
      const topL = centerX - topLen/2;
      const topR = centerX + topLen/2;
      const A={x:botL,y:baseY}, B={x:botR,y:baseY}, C={x:topR,y:topY}, D={x:topL,y:topY};
      inner += `
        ${examHeader(`上底 = ${q.a}　下底 = ${q.b}　高 = ${q.h}`)}
        <polygon points="${A.x},${A.y} ${B.x},${B.y} ${C.x},${C.y} ${D.x},${D.y}" ${fill} ${stroke} filter="url(#softShadow)"/>
        <line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}" stroke="rgba(15,23,42,.62)" stroke-width="6" stroke-linecap="round"/>
        <line x1="${D.x}" y1="${D.y}" x2="${C.x}" y2="${C.y}" stroke="rgba(15,23,42,.35)" stroke-width="6" stroke-linecap="round"/>
      `;
    }

    $("#svgHost").innerHTML = svgWrap(inner,W,H);
  }

  /* ========================= 作答 ========================= */
  function onCorrect(msg){
    state.correct++;
    state.combo++;
    const mult = multFor(state.combo);
    const gain = Math.round(50 * mult);
    state.score += gain;
    addTime(+5);

    setFeedback(`${msg} +5 秒｜分數 +${gain}｜Combo ${state.combo}（x${mult.toFixed(1)}）`, "good");
    $("#stTip").textContent = pick([ "穩住，你正在變強。", "這手感很可以。", "公式只是門票，理解才是翅膀。", "漂亮，像詩一樣精準。" ]);

    renderHUD();
    setTimeout(()=>buildQuestion(), state.cfg.nextDelay);
  }
  function onWrong(msg){
    state.wrong++;
    state.combo=0;
    state.score = Math.max(0, state.score - 15);
    addTime(-5);

    setFeedback(`${msg} -5 秒｜Combo 歸零`, "bad");
    $("#stTip").textContent = pick([ "沒事，錯一次就更清楚。", "先看圖，再決定公式。", "別急，穩定比速度更快。", "你只是還沒對上節奏。" ]);

    renderHUD();
    setTimeout(()=>buildQuestion(), state.cfg.nextDelay);
  }
  function submitAnswer(){
    if(!state.running || state.paused) return;

    if(state.level===1){
      const res = judgeLv1();
      res.ok ? onCorrect(res.msg) : onWrong(res.msg);
      return;
    }
    if(state.level===2){
      judgeLv2() ? onCorrect("高度整數剛好 ✅") : onWrong("還沒剛好～再拖一下（整數高度要完全吻合）");
      return;
    }

    const v = ($("#ansInput").value||"").trim();
    if(v===""){ setFeedback("先輸入答案～", "bad"); return; }
    const x = Number(v);
    if(!Number.isFinite(x)){ setFeedback("這不是數字喔～", "bad"); return; }

    const ok = Math.abs(x - state.answer) <= state.cfg.tolNum;
    ok ? onCorrect("答對 ✅") : onWrong(`答錯～ 正確答案是：${pretty(state.answer)} ✅`);
  }

  /* ========================= 回合 / 計時 ========================= */
  function initRunVars(){
    state.running=true;
    state.paused=false;
    state.backToMenuNoSave=false;

    state.time=60;
    state.score=0;
    state.combo=0;
    state.correct=0;
    state.wrong=0;

    state.q=null;
    state.answer=null;
    state.mode="NUM";
    state.showAns=false;

    state.stroke=[];
    state.strokeDone=false;

    state.dragTargetInt=0;
    state.dragCurInt=0;

    clearStroke();
    removeLiveHint();
    setFeedback("", "");
  }
  function startTimer(){
    stopTimer();
    const tick = state.cfg.tick;
    let acc=0;
    state.timer = setInterval(()=>{
      if(!state.running || state.paused) return;
      acc += tick;
      if(acc>=1000){
        const dec=Math.floor(acc/1000);
        acc -= dec*1000;
        state.time -= dec;
        if(state.time<=0){
          state.time=0;
          renderHUD();
          finishRun();
          return;
        }
        renderHUD();
      }
    }, tick);
  }
  function stopTimer(){
    if(state.timer){
      clearInterval(state.timer);
      state.timer=null;
    }
  }
  function finishRun(){
    stopTimer();
    state.running=false;
    state.paused=false;
    $("#pauseMask")?.classList.remove("show");
    if(!state.backToMenuNoSave){ saveToLB(); }

    renderMiniLB();

    const s=state.score;
    $("#endText").innerHTML = `分數：<b>${s}</b>　星等：<b>${starsFor(s)}</b><br>正確：<b>${state.correct}</b>　錯誤：<b>${state.wrong}</b>`;
    $("#endMask")?.classList.add("show");
  }

  /* ========================= Canvas 互動：畫線 / 拖曳 ========================= */
  let drawing=false;

  canvas?.addEventListener("pointerdown",(e)=>{
    if(!state.running || state.paused) return;

    const pPx = pointerPosPx(e);
    const pV = pxToView(pPx);

    if(state.mode==="DRAW"){
      drawing=true;
      state.stroke=[];
      state.strokeDone=false;
      state.showAns=false;
      removeLiveHint();
      state.stroke.push(pV);
      redrawOverlay();
      canvas.setPointerCapture(e.pointerId);
      return;
    }
    if(state.mode==="DRAG" && state.level===2){
      if(hitHandleLv2(pV)){
        drag.active=true;
        drag.offsetY = (pV.y - state.q.handle.y);
        canvas.setPointerCapture(e.pointerId);
      }
      return;
    }
  });

  canvas?.addEventListener("pointermove",(e)=>{
    if(!state.running || state.paused) return;

    const pPx = pointerPosPx(e);
    const pV = pxToView(pPx);

    if(drawing && state.mode==="DRAW"){
      state.stroke.push(pV);
      redrawOverlay();
      liveAngleHint();
      return;
    }
    if(drag.active && state.mode==="DRAG" && state.level===2){
      applyLv2DragY(pV.y - drag.offsetY);
      return;
    }
  });

  canvas?.addEventListener("pointerup",()=>{
    if(drawing && state.mode==="DRAW"){
      drawing=false;
      state.strokeDone=true;
      redrawOverlay();
      return;
    }
    if(drag.active && state.mode==="DRAG" && state.level===2){
      drag.active=false;
      return;
    }
  });

  /* ========================= 控制按鈕 ========================= */
  $("#btnSubmit")?.addEventListener("click", submitAnswer);
  $("#ansInput")?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submitAnswer(); });

  $("#btnClearDraw")?.addEventListener("click", ()=>{
    state.showAns=false;
    clearStroke();
    removeLiveHint();
    setFeedback("", "");
  });
  $("#btnShowAns")?.addEventListener("click", ()=>{
    if(!state.running || state.paused) return;
    state.showAns=!state.showAns;
    redrawOverlay();
    setFeedback(state.showAns ? "已顯示正解（綠色虛線）" : "已關閉正解顯示", "good");
  });

  $("#btnPause")?.addEventListener("click", ()=>{
    if(!state.running) return;
    state.paused=true;
    $("#pauseMask")?.classList.add("show");
  });
  $("#btnResume")?.addEventListener("click", ()=>{
    state.paused=false;
    $("#pauseMask")?.classList.remove("show");
  });
  $("#btnRestart")?.addEventListener("click", ()=>{
    if(!confirm("重新：同關同難度重開（60 秒、分數歸零）？")) return;
    initRunVars();
    renderHUD();
    renderMiniLB();
    buildQuestion();
    startTimer();
  });
  $("#btnBackMenu")?.addEventListener("click", ()=>{
    if(!confirm("回關卡主選單：本局不寫入排行榜，確定嗎？")) return;
    state.backToMenuNoSave=true;
    stopTimer();
    state.running=false;
    state.paused=false;
    $("#pauseMask")?.classList.remove("show");
    $("#endMask")?.classList.remove("show");
    goPage("page-menu");
    renderMenuLB();
  });

  $("#btnEndToMenu")?.addEventListener("click", ()=>{
    $("#endMask")?.classList.remove("show");
    goPage("page-menu");
    renderMenuLB();
  });
  $("#btnEndAgain")?.addEventListener("click", ()=>{
    $("#endMask")?.classList.remove("show");
    initRunVars();
    renderHUD();
    renderMiniLB();
    buildQuestion();
    startTimer();
  });

  /* ========================= 登入頁 ========================= */
  const nameInput = $("#nameInput");
  const savedName = (localStorage.getItem("JM_PLAYER_NAME")||"").trim();
  if(savedName && nameInput) nameInput.value = savedName;

  $("#btnIntroClear")?.addEventListener("click", ()=>{
    localStorage.removeItem("JM_PLAYER_NAME");
    if(nameInput){
      nameInput.value="";
      nameInput.focus();
    }
  });
  $("#btnIntroGo")?.addEventListener("click", ()=>{
    const v = (nameInput?.value || "").trim();
    if(!v){
      if(nameInput){
        nameInput.focus();
        nameInput.placeholder="名字不能空白喔～";
      }
      return;
    }
    state.name = v.slice(0,12);
    localStorage.setItem("JM_PLAYER_NAME", state.name);
    $("#menuPlayer").textContent = state.name;
    goPage("page-menu");
    renderMenuLB();
  });
  nameInput?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("#btnIntroGo")?.click(); });

  /* ========================= 選單頁 ========================= */
  document.querySelectorAll("#levelCards .card").forEach(card=>{
    card.addEventListener("click", ()=>{
      document.querySelectorAll("#levelCards .card").forEach(c=>c.classList.remove("active"));
      card.classList.add("active");
      selectedLv = Number(card.dataset.lv);
      $("#btnPlay").disabled=false;
      renderMenuLB();
    });
  });
  document.querySelectorAll("input[name='diff']").forEach(r=>r.addEventListener("change", renderMenuLB));
  $("#btnBackIntro")?.addEventListener("click", ()=>goPage("page-intro"));
  $("#btnWipeLB")?.addEventListener("click", ()=>{
    if(confirm("確定清空本機排行榜？（清掉就回不來）")){
      clearAllLB();
      renderMenuLB();
      alert("排行榜已清空 ✅");
    }
  });

  $("#btnPlay")?.addEventListener("click", ()=>{
    const v = (localStorage.getItem("JM_PLAYER_NAME")||"").trim();
    if(!v){ goPage("page-intro"); return; }

    state.name=v;
    $("#menuPlayer").textContent=v;

    const df = document.querySelector("input[name='diff']:checked")?.value || "E";
    state.level=selectedLv;
    state.diff=df;
    state.cfg=diffCfg(df);

    initRunVars();
    renderHUD();
    renderMiniLB();
    buildQuestion();
    startTimer();
    goPage("page-game");
  });

  /* ========================= 初始啟動 ========================= */
  (function boot(){
    const v = (localStorage.getItem("JM_PLAYER_NAME")||"").trim();
    if(v){ state.name=v; $("#menuPlayer").textContent=v; }
    renderMenuLB();
    // 讓首次進入時 canvas 比較不會 0x0
    requestAnimationFrame(()=>resizeCanvasToStage());
  })();
})();
</script>
</body>
</html>
