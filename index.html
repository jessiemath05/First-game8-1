<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">

    <!-- âœ… å¿«å–é€£çµé è¦½ï¼ˆè«‹æ”¾åœ¨ <head> è£¡ï¼‰ -->
    <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <!-- âœ… LINE / FB é è¦½ç”¨ -->
    <meta property="og:title" content="Jessie Math - é¢ç©å¤§æŒ‘æˆ°">
    <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta property="og:type" content="website">

    <!-- âœ… é è¦½åœ–ç‰‡ï¼ˆæœ¬éŠæˆ²ï¼šäº”å¹´ç´šä¸»é¡Œå…« â†’ g5-u8-1.pngï¼‰ -->
    <meta property="og:image" content="g5-u8-1.png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1536">
    <meta property="og:image:alt" content="Jessie Math éŠæˆ²å°é¢">

    <!-- âœ… æœ‰äº›å¹³å°æœƒåƒè€ƒ -->
    <link rel="image_src" href="g5-u8.png">

    <!-- âœ… Twitter / Xï¼ˆå¯ç”¨åŒä¸€å¼µåœ–ï¼‰ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jessie Math - é¢ç©å¤§æŒ‘æˆ°">
    <meta name="twitter:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta name="twitter:image" content="g5-u8-1.png">

    <!-- âœ… RWDï¼ˆæ‰‹æ©Ÿ / å¹³æ¿ / é›»è…¦ï¼‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Jessie Math - é¢ç©å¤§æŒ‘æˆ°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* == CSS æ¨£å¼å€åŸŸ - æœ€çµ‚ç©©å®šç‰ˆæ¨£å¼èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ == */
        :root {
            --primary-color: #FFC300; /* é»ƒè‰² */
            --secondary-color: #333;
            --text-color: #000;
            --background-color: #f4f4f4;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            box-sizing: border-box;
        }

        /* å°èˆªåˆ— (Navbar) */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5%;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .logo-area {
            display: flex;
            align-items: center;
        }
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .navbar h1 {
            font-size: 1.5em;
            color: var(--secondary-color);
            margin: 0;
        }
        .nav-links {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .nav-button {
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            background-color: #eee;
            color: var(--secondary-color);
            white-space: nowrap;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s;
        }
        .nav-button i { margin-right: 5px; }
        .primary-button {
            background-color: var(--primary-color);
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        #game-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* å•Ÿå‹•é é¢ (Start Modal) */
        #start-modal {
            margin: 50px auto;
            width: 100%;
        }
        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            margin: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            text-align: center;
        }
        #player-name-input {
            padding: 12px; width: 100%; box-sizing: border-box; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1.3em; margin: 10px 0 20px 0;
        }
        .action-button {
            padding: 12px 25px; margin-top: 25px; background-color: var(--primary-color);
            border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;
            font-weight: bold; width: 100%;
        }
        .game-rules { margin-top: 20px; }

        /* éŠæˆ²ä»‹é¢ (Question Panel) */
        .hidden { display: none !important; }

        .status-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .game-question-panel {
            border: 1px solid #ccc; padding: 20px; min-height: 400px;
            border-radius: 5px; background-color: #fff; text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        #context-image {
            width: 100%;
            max-width: 450px;
            height: 220px;
            background-color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* SVG æ¨£å¼ä¿®æ­£ */
        .shape {
            fill: #ADD8E6;
            stroke: #000;
            stroke-width: 2;
        }
        .shape2{
            fill:#FFE4B5;
            stroke:#000;
            stroke-width:2;
        }
        .cutout{
            fill:#fff;
            stroke:#000;
            stroke-width:2;
            stroke-dasharray: 4;
        }
        .height-line { stroke: #ff0000; stroke-width: 1.5; stroke-dasharray: 4; }
        .label { font-family: Arial, sans-serif; font-size: 14px; fill: var(--secondary-color); font-weight: bold; }

        .question-text {
            font-size: 1.5em;
            margin-bottom: 25px;
            font-weight: bold;
        }
        .answer-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
        }
        .answer-area input {
            padding: 15px; font-size: 1.5em; border: 2px solid #ddd;
            border-radius: 5px; width: 180px; text-align: center; margin-right: 20px;
        }
        .submit-btn { padding: 15px 30px; font-size: 1.2em; }

        .control-buttons {
            display: flex; justify-content: space-between; gap: 20px;
            margin-top: auto; padding-top: 20px; width: 100%; max-width: 500px;
        }
        .control-btn {
            padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer;
            background-color: #e0e0e0; font-size: 1.05em; flex-grow: 1; min-width: 100px; font-weight: bold;
        }
        .feedback.correct { color: var(--success-color); font-weight: bold; }
        .feedback.incorrect { color: var(--error-color); font-weight: bold; }

        /* -------------------------------------- */
        /* 1. é›£åº¦æŒ‰éˆ•æ¨£å¼ä¿®æ­£ */
        /* -------------------------------------- */
        .difficulty-options {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
            justify-content: center; /* åœ¨å¤§è¢å¹•ä¸Šå±…ä¸­ */
        }
        .difficulty-options span {
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            border-radius: 8px; /* æ–¹ä¸­å¸¶åœ“ */
            font-size: 1.05em;
            transition: all 0.3s;
            flex-grow: 1;
            max-width: 120px;
            font-weight: bold;
        }
        .difficulty-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(255, 195, 0, 0.4);
            color: var(--secondary-color);
        }
        .difficulty-btn:hover {
            border-color: var(--primary-color);
        }
        /* -------------------------------------- */

        /* é—œå¡é¸æ“‡å€ä½ˆå±€ */
        .level-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        @media (min-width: 600px) {
            .level-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .level-card {
            padding: 30px 20px; border-radius: 10px; border: 2px solid #ddd;
            text-align: center; min-height: 150px;
            display: flex; flex-direction: column; justify-content: center;
            background-color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .level-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .level-card h3 { font-size: 1.8em; margin: 0 0 8px 0; }
        .level-card p { font-size: 1.3em; margin: 0 0 10px 0; font-weight: 500; }
        .stars { color: gold; font-size: 1.5em; margin-top: 5px; }

        /* -------------------------------------- */
        /* 2. æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ (RWD å¼·åŒ–) */
        /* -------------------------------------- */
        @media (max-width: 768px) {
            /* å°èˆªåˆ—å †ç–Š */
            .navbar {
                flex-direction: column;
                align-items: center;
                padding: 10px 3%;
                gap: 10px;
            }
            .logo-area {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            .nav-links {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap; /* å…è¨±æŒ‰éˆ•æ›è¡Œ */
                justify-content: space-around;
                margin-left: 0;
            }
            .nav-button {
                padding: 6px 10px;
                font-size: 0.85em;
                flex-grow: 1;
                margin: 2px; /* å¢åŠ å¾®å°é–“è· */
            }

            /* éŠæˆ²å®¹å™¨ */
            #game-container {
                padding: 0 10px;
            }

            /* é›£åº¦æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šå¹³å‡åˆ†é…ç©ºé–“ */
            .difficulty-btn {
                flex-grow: 1;
                max-width: none;
            }
            .difficulty-options {
                justify-content: space-between;
                gap: 5px;
            }

            /* éŠæˆ²ç‹€æ…‹æ¬„ */
            .status-bar {
                font-size: 1em;
                justify-content: space-between;
            }

            /* éŠæˆ²é¢æ¿ - ç¢ºä¿è¼¸å…¥å’ŒæŒ‰éˆ•èƒ½ç”¨ */
            .game-question-panel {
                min-height: 350px;
                padding: 15px;
            }
            .question-text {
                font-size: 1.25em;
                margin-bottom: 15px;
            }
            .answer-area {
                max-width: 100%;
                margin-bottom: 15px;
            }
            .answer-area input {
                flex-grow: 1;
                width: auto;
                padding: 12px;
                font-size: 1.3em;
                margin-right: 10px;
            }
            .submit-btn {
                padding: 12px 20px;
                font-size: 1.1em;
            }

            /* æ§åˆ¶æŒ‰éˆ• - ç¢ºä¿åœ¨æ‰‹æ©Ÿåº•éƒ¨å¯æ“ä½œ */
            .control-buttons {
                gap: 5px;
                flex-wrap: wrap;
                max-width: 100%;
                padding-top: 15px;
            }
            .control-btn {
                padding: 10px 10px;
                font-size: 0.85em;
                min-width: 80px;
            }

            /* Footerï¼šæ‰‹æ©Ÿä¸Šæ›´èˆ’æœ */
            .footer-pill{
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .footer-right{
                width: 100%;
            }
        }

        /* -------------------------------------- */
        /* 3. Footerï¼ˆæ–°å¢ï¼‰ */
        /* -------------------------------------- */
        footer{
            max-width: 900px;
            margin: 18px auto 28px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .footer-pill{
            background: rgba(255,255,255,.9);
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
            border-radius: 999px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }
        .footer-left{
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .footer-dot{
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255,195,0,.25);
            flex: 0 0 auto;
        }
        .footer-copy{
            font-size: 0.95em;
            color: #374151;
            font-weight: 700;
            white-space: nowrap;
        }
        .footer-right{
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .footer-icon{
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,195,0,.18);
            border: 1px solid rgba(255,195,0,.35);
            color: #111827;
            flex: 0 0 auto;
        }
        .footer-tagline{
            font-size: 0.98em;
            color: #111827;
            font-weight: 800;
            white-space: nowrap;
        }
        @media (max-width: 420px){
            .footer-copy, .footer-tagline{ white-space: normal; line-height: 1.25; }
            .footer-pill{ border-radius: 18px; }
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo-area">
            <img src="JESSIEMATH-Q.png" alt="Jessie Math Logo" class="profile-img">
            <h1>Jessie Math</h1>
        </div>
        <nav class="nav-links">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-button"><i class="fas fa-home"></i> é¦–é </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-button"><i class="fas fa-gamepad"></i> éŠæˆ²å¤§å»³</a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u8" class="nav-button primary-button"><i class="fas fa-arrow-left"></i> äº”å¹´ç´šé¢ç©</a>
        </nav>
    </header>

    <main id="game-container">

        <section id="start-modal" class="modal">
            <div class="modal-content">
                <h2>æ­¡è¿ä¾†åˆ°é¢ç©å¤§æŒ‘æˆ°ï¼</h2>
                <p style="margin-top: 15px; margin-bottom: 5px;">è«‹è¼¸å…¥æ‚¨çš„åå­—é–‹å§‹éŠæˆ²:</p>
                <input type="text" id="player-name-input" placeholder="æ‚¨çš„åå­—" maxlength="10">

                <div class="game-rules">
                    <h3>ğŸ“š éŠæˆ²è¦å‰‡èªªæ˜</h3>
                    <ul>
                        <li>è¨ˆæ™‚ï¼šæ¯å›åˆ **60 ç§’**ï¼Œç­”å° **+5 ç§’**ï¼Œç­”éŒ¯ **-5 ç§’**ã€‚</li>
                        <li>è¨ˆåˆ†ï¼šç­”å°å¾—åˆ†ï¼Œé€£çºŒç­”å°è§¸ç™¼ **Combo é€£æ“Š** (æœ€é«˜ 1.5 å€åˆ†)ã€‚</li>
                        <li>ç›®æ¨™ï¼šåœ¨æ™‚é–“å…§ç²å¾—é«˜åˆ†ï¼ŒæŒ‘æˆ° **ä¸‰é¡†æ˜Ÿ** è©•åƒ¹ï¼</li>
                    </ul>
                </div>
                <button id="start-game-button" class="action-button">ç¢ºèªä¸¦é¸æ“‡é—œå¡</button>
            </div>
        </section>

        <section id="level-selection" class="game-view hidden">
            <h2>ğŸ† é¸æ“‡é—œå¡èˆ‡é›£åº¦</h2>

            <div class="difficulty-options">
                <span>é›£åº¦/é€Ÿåº¦ï¼š</span>
                <button data-speed="easy" class="difficulty-btn active">ç°¡å–®</button>
                <button data-speed="medium" class="difficulty-btn">æ™®é€š</button>
                <button data-speed="hard" class="difficulty-btn">å›°é›£</button>
            </div>

            <div class="level-grid">
                <button data-level="1" class="level-card">
                    <h3>é—œå¡ 1</h3>
                    <p>ğŸ”· å¹³è¡Œå››é‚Šå½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="2" class="level-card">
                    <h3>é—œå¡ 2</h3>
                    <p>ğŸ”º ä¸‰è§’å½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="3" class="level-card">
                    <h3>é—œå¡ 3</h3>
                    <p>ğŸ”² æ¢¯å½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="4" class="level-card mixed-level">
                    <h3>é—œå¡ 4</h3>
                    <p>ğŸŒ€ è¤‡åˆå¼é¢ç© (æ··åˆ)</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
            </div>

            <button id="show-leaderboard-btn" class="action-button secondary-button"><i class="fas fa-list-ol"></i> æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </section>

        <section id="game-play-area" class="game-view hidden">
            <div class="status-bar">
                <div id="timer-display" class="timer">â³ 60s</div>
                <div id="score-display" class="score score-display">å¾—åˆ†: 0</div>
                <div id="combo-display" class="combo combo-display">é€£æ“Š: 0</div>
            </div>

            <div class="game-question-panel">
                <div id="context-image" class="context-image-placeholder">
                    è«‹é¸æ“‡é—œå¡é–‹å§‹éŠæˆ²ã€‚
                </div>

                <div id="question-text" class="question-text">
                    æº–å‚™å¥½äº†å—ï¼Ÿ
                </div>

                <div id="answer-area" class="answer-area">
                    <input type="number" id="answer-input" placeholder="å¡«å…¥ç­”æ¡ˆ (æ•´æ•¸)">
                    <button id="submit-answer-btn" class="action-button primary-button submit-btn">é€å‡ºç­”æ¡ˆ</button>
                </div>
                <div id="feedback-message" class="feedback"></div>

                <div class="control-buttons">
                    <button id="reset-button" class="control-btn"><i class="fas fa-redo"></i> é‡æ–°</button>
                    <button id="pause-button" class="control-btn"><i class="fas fa-pause"></i> æš«åœ</button>
                    <button id="exit-button" class="control-btn"><i class="fas fa-sign-out-alt"></i> å›é—œå¡ä¸»é¸å–®</button>
                </div>
            </div>
        </section>

        <div id="pause-overlay" class="modal hidden">
            <div class="modal-content pause-content">
                <h2>â¸ éŠæˆ²æš«åœä¸­</h2>
                <button id="resume-button" class="action-button">ç¹¼çºŒéŠæˆ²</button>
            </div>
        </div>

        <div id="result-modal" class="modal hidden">
            <div class="modal-content">
                <h2>ğŸ‰ æŒ‘æˆ°çµæŸï¼</h2>
                <p>ç©å®¶ï¼š<span id="final-player-name"></span></p>
                <p>æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score"></span></p>
                <div id="final-stars" class="stars result-stars"></div>
                <p id="star-message"></p>

                <div id="correct-answer-display" class="correct-answer-info">
                    <h4>æœ¬å±€é¡Œç›®å›é¡§ï¼š</h4>
                </div>

                <button id="back-to-select" class="action-button">è¿”å›é—œå¡é¸æ“‡</button>
            </div>
        </div>

        <section id="leaderboard-view" class="game-view hidden">
            <h2>ğŸ¥‡ æ’è¡Œæ¦œ</h2>
            <ul id="leaderboard-list">
            </ul>
            <button id="back-from-leaderboard" class="action-button secondary-button">è¿”å›</button>
        </section>

    </main>

    <!-- âœ… Footerï¼ˆæ–°å¢ï¼‰ -->
    <footer>
        <div class="footer-pill">
            <div class="footer-left">
                <div class="footer-dot" aria-hidden="true"></div>
                <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
            </div>
            <div class="footer-right">
                <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
                <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
            </div>
        </div>
    </footer>

    <script>
        // å°‡æ‰€æœ‰é‚è¼¯åŒ…åœ¨ window.onload ç¢ºä¿ DOM è¼‰å…¥å®Œæˆï¼Œè§£æ±ºã€ŒéŠæˆ²é€²ä¸å»ã€çš„å•é¡Œ
        window.onload = function() {
            /* == JavaScript éŠæˆ²é‚è¼¯å€åŸŸ == */

            // == æ ¸å¿ƒè®Šæ•¸ ==
            let playerName = '';
            let currentLevel = 0;
            let currentScore = 0;
            let currentCombo = 0;
            let timeLeft = 60;
            let timerInterval = null;
            let isPaused = false;
            let questionHistory = [];

            // == DOM å…ƒç´  ==
            const startModal = document.getElementById('start-modal');
            const levelSelection = document.getElementById('level-selection');
            const gamePlayArea = document.getElementById('game-play-area');
            const pauseOverlay = document.getElementById('pause-overlay');
            const resultModal = document.getElementById('result-modal');
            const leaderboardView = document.getElementById('leaderboard-view');
            const contextImage = document.getElementById('context-image');

            const playerNameInput = document.getElementById('player-name-input');
            const timerDisplay = document.getElementById('timer-display');
            const scoreDisplay = document.getElementById('score-display');
            const comboDisplay = document.getElementById('combo-display');
            const questionText = document.getElementById('question-text');
            const answerInput = document.getElementById('answer-input');
            const submitButton = document.getElementById('submit-answer-btn');

            const STAR_THRESHOLD = { 1: 50, 2: 150, 3: 300 };

            // == è¼”åŠ©å‡½å¼ ==
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

            function getRandomEven(min, max) {
                let num = getRandomInt(min, max);
                return num % 2 === 0 ? num : num + 1;
            }
            function getRandomMultiple(min, max, m){
                const a = Math.ceil(min / m);
                const b = Math.floor(max / m);
                return getRandomInt(a, b) * m;
            }
            function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

            // SVG åŸºæœ¬æ¡†
            function svgWrap(inner, w=350, h=200){
                return `
                    <svg width="${w}" height="${h}" class="area-diagram" viewBox="0 0 ${w} ${h}">
                        <rect width="${w}" height="${h}" fill="white"/>
                        ${inner}
                    </svg>
                `;
            }

            // == å‡½å¼ï¼šä»‹é¢æ§åˆ¶ (ç¢ºä¿åˆ‡æ›é‚è¼¯ç„¡èª¤) ==
            const allViews = [startModal, levelSelection, gamePlayArea, resultModal, leaderboardView, pauseOverlay];
            function showView(viewElement) {
                allViews.forEach(el => {
                    if (el) el.classList.add('hidden');
                });
                if (viewElement) viewElement.classList.remove('hidden');
            }

            function startTimer() {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (!isPaused) {
                        timeLeft--;
                        timerDisplay.textContent = `â³ ${timeLeft}s`;
                        if (timeLeft <= 0) {
                            endGame();
                        }
                    }
                }, 1000);
            }

            function togglePause() {
                if (gamePlayArea.classList.contains('hidden')) return;

                isPaused = !isPaused;
                if (isPaused) {
                    showView(pauseOverlay);
                    document.getElementById('pause-button').innerHTML = '<i class="fas fa-play"></i> ç¹¼çºŒ';
                } else {
                    showView(gamePlayArea);
                    document.getElementById('pause-button').innerHTML = '<i class="fas fa-pause"></i> æš«åœ';
                }
            }

            function startGame(level) {
                clearInterval(timerInterval);
                timeLeft = 60;
                currentScore = 0;
                currentCombo = 0;
                questionHistory = [];
                isPaused = false;

                timerDisplay.textContent = `â³ ${timeLeft}s`;
                scoreDisplay.textContent = `å¾—åˆ†: ${currentScore}`;
                comboDisplay.textContent = `é€£æ“Š: ${currentCombo}`;

                currentLevel = level;
                showView(gamePlayArea);
                startTimer();
                generateQuestion(level);
                answerInput.value = '';
                answerInput.focus();
            }

            // ==============================
            // é¡Œåº«ï¼šå››é—œã€Œæ›´å¤šè®ŠåŒ–ã€ç‰ˆæœ¬
            // ==============================

            // âœ… ä¿®æ­£ï¼šä¸å†ç”¨ Math.round äº‚æ”¹ç­”æ¡ˆï¼Œç¢ºä¿é¡Œç›®ç”Ÿæˆçš„æ­£ç¢ºç­”æ¡ˆã€ŒåŸæ¨£ã€å­˜å…¥
            function setQA(questionHtml, svgContent, correctAns){
                const ans = Number(correctAns);
                questionText.innerHTML = questionHtml;
                contextImage.innerHTML = svgContent;

                // å­˜æˆæ•´æ•¸å­—ä¸²ï¼ˆä½ çš„é¡Œåº«è¨­è¨ˆæœ¬ä¾†å°±éƒ½æ‡‰è©²æ˜¯æ•´æ•¸ï¼‰
                const ansInt = Number.isFinite(ans) ? Math.trunc(ans) : 0;
                questionText.dataset.correctAnswer = String(ansInt);

                questionHistory.push({
                    question: questionHtml.replace(/<br>/g, ', '),
                    correct: String(ansInt),
                    playerAnswer: null
                });
            }

            // --- é—œå¡1ï¼šå¹³è¡Œå››é‚Šå½¢ ---
            function qPara_area(){
                const unit = 'cm';
                const base = getRandomEven(8, 24);
                const height = getRandomEven(6, 14);
                const correct = base * height;

                const offset = clamp(height * 4, 25, 70);
                const svg = svgWrap(`
                    <polygon class="shape" points="${offset},170 330,170 ${330-offset},30 20,30"/>
                    <line class="height-line" x1="${330-offset}" y1="30" x2="${330-offset}" y2="170"/>
                    <text class="label" x="175" y="192" text-anchor="middle">åº•: ${base}${unit}</text>
                    <text class="label" x="${330-offset-10}" y="105" text-anchor="end" fill="#ff0000">é«˜: ${height}${unit}</text>
                `);

                const html = `è«‹è¨ˆç®—ä¸‹åˆ—**å¹³è¡Œå››é‚Šå½¢**çš„é¢ç©ï¼š<br>åº• = ${base} ${unit}, é«˜ = ${height} ${unit}ã€‚`;
                return {html, svg, correct};
            }

            function qPara_findHeight(){
                const unit = 'cm';
                const base = getRandomEven(8, 24);
                const height = getRandomEven(6, 14);
                const area = base * height;
                const correct = height;

                const offset = clamp(height * 4, 25, 70);
                const svg = svgWrap(`
                    <polygon class="shape" points="${offset},170 330,170 ${330-offset},30 20,30"/>
                    <line class="height-line" x1="${330-offset}" y1="30" x2="${330-offset}" y2="170"/>
                    <text class="label" x="175" y="192" text-anchor="middle">åº•: ${base}${unit}</text>
                    <text class="label" x="175" y="18" text-anchor="middle">é¢ç©: ${area} å¹³æ–¹${unit}</text>
                    <text class="label" x="${330-offset-10}" y="105" text-anchor="end" fill="#ff0000">é«˜: ?</text>
                `);

                const html = `å·²çŸ¥ä¸‹åˆ—**å¹³è¡Œå››é‚Šå½¢**é¢ç©ç‚º ${area} å¹³æ–¹${unit}ï¼Œåº•ç‚º ${base} ${unit}ï¼Œè«‹å•é«˜æ˜¯å¤šå°‘${unit}ï¼Ÿ`;
                return {html, svg, correct};
            }

            function qPara_ratio(){
                const unit = 'cm';
                const base = getRandomEven(8, 18);
                const h1 = getRandomEven(4, 10);
                const k = pick([2,3,4]);
                const h2 = h1 * k;
                const correct = k;

                const offset1 = clamp(h1 * 4, 20, 60);
                const offset2 = clamp(h2 * 2, 25, 70);

                const svg = svgWrap(`
                    <!-- ç”² -->
                    <polygon class="shape" points="${offset1},170 160,170 ${160-offset1},60 20,60"/>
                    <line class="height-line" x1="${160-offset1}" y1="60" x2="${160-offset1}" y2="170"/>
                    <text class="label" x="90" y="190" text-anchor="middle">ç”² åº•:${base}${unit}</text>
                    <text class="label" x="${160-offset1}" y="120" text-anchor="end" fill="#ff0000">é«˜:${h1}${unit}</text>

                    <!-- ä¹™ -->
                    <polygon class="shape2" points="${200+offset2},170 330,170 ${330-offset2},30 200,30"/>
                    <line class="height-line" x1="${330-offset2}" y1="30" x2="${330-offset2}" y2="170"/>
                    <text class="label" x="265" y="190" text-anchor="middle">ä¹™ åº•:${base}${unit}</text>
                    <text class="label" x="${330-offset2}" y="105" text-anchor="end" fill="#ff0000">é«˜:${h2}${unit}</text>
                `);

                const html = `ç”²ã€ä¹™å…©å€‹**å¹³è¡Œå››é‚Šå½¢**çš„åº•ç›¸ç­‰ã€‚ä¹™çš„é«˜æ˜¯ç”²çš„ ${k} å€ï¼Œè«‹å•ä¹™çš„é¢ç©æ˜¯ç”²çš„å¹¾å€ï¼Ÿ`;
                return {html, svg, correct};
            }

            // --- é—œå¡2ï¼šä¸‰è§’å½¢ ---
            function qTri_area(){
                const unit='cm';
                const base = getRandomEven(8, 24);
                const height = getRandomInt(6, 16);
                const correct = (base * height) / 2;

                const svg = svgWrap(`
                    <polygon class="shape" points="20,170 330,170 175,30"/>
                    <line class="height-line" x1="175" y1="30" x2="175" y2="170"/>
                    <text class="label" x="175" y="192" text-anchor="middle">åº•: ${base}${unit}</text>
                    <text class="label" x="185" y="105" fill="#ff0000">é«˜: ${height}${unit}</text>
                `);
                const html = `è«‹è¨ˆç®—ä¸‹åˆ—**ä¸‰è§’å½¢**çš„é¢ç©ï¼š<br>åº• = ${base} ${unit}, é«˜ = ${height} ${unit}ã€‚`;
                return {html, svg, correct};
            }

            function qTri_findHeight(){
                const unit='cm';
                const base = getRandomEven(8, 24);
                const height = getRandomInt(6, 16);
                const area = (base * height)/2;
                const correct = height;

                const svg = svgWrap(`
                    <polygon class="shape" points="20,170 330,170 175,30"/>
                    <line class="height-line" x1="175" y1="30" x2="175" y2="170"/>
                    <text class="label" x="175" y="192" text-anchor="middle">åº•: ${base}${unit}</text>
                    <text class="label" x="175" y="18" text-anchor="middle">é¢ç©: ${area} å¹³æ–¹${unit}</text>
                    <text class="label" x="185" y="105" fill="#ff0000">é«˜: ?</text>
                `);
                const html = `å·²çŸ¥ä¸‹åˆ—**ä¸‰è§’å½¢**é¢ç©ç‚º ${area} å¹³æ–¹${unit}ï¼Œåº•ç‚º ${base} ${unit}ï¼Œè«‹å•é«˜æ˜¯å¤šå°‘${unit}ï¼Ÿ`;
                return {html, svg, correct};
            }

            function qTri_multiplier(){
                const a = pick([2,3,4]);
                const b = pick([2,3,4]);
                const correct = a * b;

                const svg = svgWrap(`
                    <polygon class="shape" points="30,170 160,170 95,60"/>
                    <line class="height-line" x1="95" y1="60" x2="95" y2="170"/>
                    <text class="label" x="95" y="192" text-anchor="middle">åŸä¾†</text>
                    <text class="label" x="95" y="50" fill="#ff0000">é«˜</text>

                    <polygon class="shape2" points="190,170 330,170 260,30"/>
                    <line class="height-line" x1="260" y1="30" x2="260" y2="170"/>
                    <text class="label" x="260" y="192" text-anchor="middle">æ”¹è®Šå¾Œ</text>
                `);

                const html = `ä¸€å€‹ä¸‰è§’å½¢çš„åº•è®ŠæˆåŸä¾†çš„ ${a} å€ï¼Œé«˜è®ŠæˆåŸä¾†çš„ ${b} å€ï¼Œè«‹å•é¢ç©è®ŠæˆåŸä¾†çš„å¹¾å€ï¼Ÿ`;
                return {html, svg, correct};
            }

            // --- é—œå¡3ï¼šæ¢¯å½¢ ---
            function qTrap_area(){
                const unit='cm';
                const top = getRandomEven(6, 18);
                const bottom = getRandomEven(14, 28);
                const h = getRandomEven(6, 16);
                const correct = (top + bottom) * h / 2;

                const svg = svgWrap(`
                    <polygon class="shape" points="70,40 280,40 320,170 30,170"/>
                    <line class="height-line" x1="175" y1="40" x2="175" y2="170"/>
                    <text class="label" x="175" y="30" text-anchor="middle">ä¸Šåº•: ${top}${unit}</text>
                    <text class="label" x="175" y="192" text-anchor="middle">ä¸‹åº•: ${bottom}${unit}</text>
                    <text class="label" x="185" y="110" fill="#ff0000">é«˜: ${h}${unit}</text>
                `);
                const html = `è«‹è¨ˆç®—ä¸‹åˆ—**æ¢¯å½¢**çš„é¢ç©ï¼š<br>ä¸Šåº• = ${top} ${unit}, ä¸‹åº• = ${bottom} ${unit}, é«˜ = ${h} ${unit}ã€‚`;
                return {html, svg, correct};
            }

            function qTrap_findTop(){
                const unit='cm';
                const top = getRandomEven(6, 16);
                const bottom = getRandomEven(18, 30);
                const h = getRandomEven(6, 16);
                const area = (top + bottom) * h / 2;

                const correct = top;

                const svg = svgWrap(`
                    <polygon class="shape" points="70,40 280,40 320,170 30,170"/>
                    <line class="height-line" x1="175" y1="40" x2="175" y2="170"/>
                    <text class="label" x="175" y="192" text-anchor="middle">ä¸‹åº•: ${bottom}${unit}</text>
                    <text class="label" x="185" y="110" fill="#ff0000">é«˜: ${h}${unit}</text>
                    <text class="label" x="175" y="30" text-anchor="middle">ä¸Šåº•: ?</text>
                    <text class="label" x="175" y="18" text-anchor="middle">é¢ç©: ${area} å¹³æ–¹${unit}</text>
                `);

                const html = `å·²çŸ¥ä¸‹åˆ—**æ¢¯å½¢**é¢ç©ç‚º ${area} å¹³æ–¹${unit}ï¼Œä¸‹åº•ç‚º ${bottom} ${unit}ï¼Œé«˜ç‚º ${h} ${unit}ï¼Œè«‹å•ä¸Šåº•æ˜¯å¤šå°‘${unit}ï¼Ÿ`;
                return {html, svg, correct};
            }

            function qTrap_multiplier(){
                const k = pick([2,3,4]);
                const correct = k;

                const svg = svgWrap(`
                    <polygon class="shape" points="60,60 170,60 200,170 30,170"/>
                    <line class="height-line" x1="115" y1="60" x2="115" y2="170"/>
                    <text class="label" x="115" y="192" text-anchor="middle">åŸä¾†</text>

                    <polygon class="shape2" points="210,30 330,30 340,170 190,170"/>
                    <line class="height-line" x1="265" y1="30" x2="265" y2="170"/>
                    <text class="label" x="265" y="192" text-anchor="middle">é«˜è®Šæˆ ${k} å€</text>
                `);

                const html = `ä¸€å€‹æ¢¯å½¢çš„ä¸Šåº•èˆ‡ä¸‹åº•éƒ½ä¸è®Šï¼Œé«˜è®ŠæˆåŸä¾†çš„ ${k} å€ï¼Œè«‹å•é¢ç©è®ŠæˆåŸä¾†çš„å¹¾å€ï¼Ÿ`;
                return {html, svg, correct};
            }

            // --- é—œå¡4ï¼šè¤‡åˆå¼é¢ç© ---
            function qMix_trapPlusTri(){
                const unit='cm';
                const Ta = getRandomEven(6, 12);
                const Tb = getRandomEven(14, 24);
                const Th = getRandomEven(4, 10);
                const trape = (Ta + Tb) * Th / 2;

                const TriBase = Tb;
                const TriH = getRandomEven(6, 14);
                const tri = TriBase * TriH / 2;

                const correct = trape + tri;

                const svg = svgWrap(`
                    <polygon class="shape2" points="90,30 260,30 305,95 45,95"/>
                    <polygon class="shape" points="45,95 305,95 175,175"/>
                    <line class="height-line" x1="175" y1="30" x2="175" y2="95"/>
                    <line class="height-line" x1="175" y1="95" x2="175" y2="175"/>
                    <text class="label" x="175" y="24" text-anchor="middle">æ¢¯å½¢ ä¸Šåº•:${Ta}${unit}</text>
                    <text class="label" x="175" y="115" text-anchor="middle">å…±ç”¨åº•:${Tb}${unit}</text>
                    <text class="label" x="185" y="70" fill="#ff0000">æ¢¯é«˜:${Th}${unit}</text>
                    <text class="label" x="185" y="150" fill="#ff0000">ä¸‰é«˜:${TriH}${unit}</text>
                `);

                const html = `**è«‹è¨ˆç®—ä¸‹åˆ—è¤‡åˆåœ–å½¢çš„ç¸½é¢ç©ï¼š**<br>ç”±ä¸€å€‹æ¢¯å½¢ (ä¸Šåº•${Ta}ã€ä¸‹åº•${Tb}ã€é«˜${Th}) èˆ‡ä¸€å€‹ä»¥æ¢¯å½¢ä¸‹åº•ç‚ºåº•çš„ä¸‰è§’å½¢ (é«˜${TriH}) çµ„æˆã€‚`;
                return {html, svg, correct};
            }

            function qMix_rectMinusTri(){
                const unit='cm';
                const W = getRandomMultiple(20, 60, 4);
                const H = getRandomEven(20, 50);
                const triBase = getRandomMultiple(10, Math.min(30, W-8), 2);
                const triHeight = H;
                const rectArea = W * H;
                const triArea = triBase * triHeight / 2;
                const correct = rectArea - triArea;

                const svg = svgWrap(`
                    <rect x="40" y="35" width="270" height="140" class="shape2"/>
                    <polygon points="40,175 ${40+ (triBase/W)*270},175 40,35" class="cutout"/>
                    <text class="label" x="175" y="30" text-anchor="middle">é•·æ–¹å½¢ï¼š${W}${unit} Ã— ${H}${unit}</text>
                    <text class="label" x="175" y="192" text-anchor="middle">æŒ–æ‰ä¸‰è§’å½¢ åº•:${triBase}${unit} é«˜:${triHeight}${unit}</text>
                `);

                const html = `æ±‚é‹ªè‰²éƒ¨åˆ†çš„é¢ç©ï¼š<br>ä¸€å€‹é•·æ–¹å½¢ ${W}Ã—${H}ï¼ˆ${unit}ï¼‰ï¼ŒæŒ–æ‰ä¸€å€‹ç›´è§’ä¸‰è§’å½¢ï¼ˆåº•${triBase}${unit}ï¼Œé«˜${triHeight}${unit}ï¼‰ã€‚é‹ªè‰²éƒ¨åˆ†é¢ç©æ˜¯å¤šå°‘ï¼ˆå¹³æ–¹${unit}ï¼‰ï¼Ÿ`;
                return {html, svg, correct};
            }

            function qMix_paraMinusTri(){
                const unit='cm';
                const base = getRandomEven(20, 40);
                const height = getRandomEven(12, 24);
                const cutBase = getRandomEven(6, 16);
                const cutHeight = getRandomEven(6, height);

                const paraArea = base * height;
                const triArea = cutBase * cutHeight / 2;
                const correct = paraArea - triArea;

                const offset = clamp(height * 2, 25, 70);
                const svg = svgWrap(`
                    <!-- å¹³è¡Œå››é‚Šå½¢ -->
                    <polygon class="shape" points="${offset},175 330,175 ${330-offset},35 20,35"/>
                    <!-- ç¼ºè§’ä¸‰è§’å½¢ï¼ˆè™›ç·šï¼‰ -->
                    <polygon class="cutout" points="${330-offset},35 ${330-offset},${35+ (cutHeight/height)*140} ${330-offset - (cutBase/base)*260},${35+ (cutHeight/height)*140}"/>
                    <line class="height-line" x1="${330-offset}" y1="35" x2="${330-offset}" y2="175"/>
                    <text class="label" x="175" y="192" text-anchor="middle">åº•:${base}${unit}</text>
                    <text class="label" x="${330-offset-10}" y="110" text-anchor="end" fill="#ff0000">é«˜:${height}${unit}</text>
                    <text class="label" x="175" y="20" text-anchor="middle">æŒ–æ‰ä¸‰è§’å½¢ åº•:${cutBase}${unit} é«˜:${cutHeight}${unit}</text>
                `);

                const html = `æ±‚é‹ªè‰²éƒ¨åˆ†çš„é¢ç©ï¼š<br>å¹³è¡Œå››é‚Šå½¢ åº•${base}${unit}ã€é«˜${height}${unit}ï¼ŒæŒ–æ‰ä¸€å€‹ä¸‰è§’å½¢ï¼ˆåº•${cutBase}${unit}ã€é«˜${cutHeight}${unit}ï¼‰ã€‚é‹ªè‰²éƒ¨åˆ†é¢ç©æ˜¯å¤šå°‘ï¼ˆå¹³æ–¹${unit}ï¼‰ï¼Ÿ`;
                return {html, svg, correct};
            }

            function qMix_trapMinus2Rect(){
                const unit='cm';
                const top = getRandomEven(16, 26);
                const bottom = top + getRandomEven(8, 16);
                const h = getRandomEven(10, 18);
                const trapArea = (top + bottom) * h / 2;

                const cutW = getRandomEven(2, 6);
                const cutH = h;
                const cuts = 2 * (cutW * cutH);
                const correct = trapArea - cuts;

                const svg = svgWrap(`
                    <polygon class="shape2" points="75,45 275,45 320,175 30,175"/>
                    <rect x="30" y="45" width="${(cutW/ (bottom))*290}" height="130" class="cutout"/>
                    <rect x="${320 - (cutW/(bottom))*290}" y="45" width="${(cutW/(bottom))*290}" height="130" class="cutout"/>
                    <line class="height-line" x1="175" y1="45" x2="175" y2="175"/>
                    <text class="label" x="175" y="30" text-anchor="middle">ä¸Šåº•:${top}${unit} ä¸‹åº•:${bottom}${unit}</text>
                    <text class="label" x="185" y="115" fill="#ff0000">é«˜:${h}${unit}</text>
                    <text class="label" x="175" y="192" text-anchor="middle">å…©å´å„åˆ‡æ‰ï¼š${cutW}${unit}Ã—${cutH}${unit}</text>
                `);

                const html = `æ±‚é‹ªè‰²éƒ¨åˆ†çš„é¢ç©ï¼š<br>ä¸€å€‹æ¢¯å½¢ï¼ˆä¸Šåº•${top}${unit}ã€ä¸‹åº•${bottom}${unit}ã€é«˜${h}${unit}ï¼‰ï¼Œå·¦å³å…©å´å„åˆ‡æ‰ä¸€å€‹é•·æ–¹å½¢ï¼ˆ${cutW}${unit}Ã—${cutH}${unit}ï¼‰ã€‚é‹ªè‰²éƒ¨åˆ†é¢ç©æ˜¯å¤šå°‘ï¼ˆå¹³æ–¹${unit}ï¼‰ï¼Ÿ`;
                return {html, svg, correct};
            }

            // æ ¸å¿ƒï¼šç”Ÿæˆé¡Œç›®å’Œ SVG åœ–å½¢ï¼ˆå››é—œé¡Œåº«æ“´å……ï¼‰
            function generateQuestion(level) {
                let pack;

                if (level === 1){
                    pack = pick([qPara_area, qPara_findHeight, qPara_ratio])();
                } else if (level === 2){
                    pack = pick([qTri_area, qTri_findHeight, qTri_multiplier])();
                } else if (level === 3){
                    pack = pick([qTrap_area, qTrap_findTop, qTrap_multiplier])();
                } else if (level === 4){
                    pack = pick([qMix_trapPlusTri, qMix_rectMinusTri, qMix_paraMinusTri, qMix_trapMinus2Rect])();
                } else {
                    pack = { html: 'é¸æ“‡é—œå¡é–‹å§‹éŠæˆ²ã€‚', svg: '', correct: 0 };
                }

                setQA(pack.html, pack.svg, pack.correct);
            }

            // âœ… ä¿®æ­£ï¼šç­”æ¡ˆæ¯”å°ç”¨ã€Œæ•´æ•¸åŒ–ã€ä¸”ç”¨ Number è®€å–æ­£ç¢ºç­”æ¡ˆï¼Œé¿å…å­—ä¸²/parseInt é€ æˆæ€ªèª¤å·®
            function checkAnswer(playerAnswer) {
                if (isPaused) return;

                const roundedPlayerAnswer = Math.trunc(Number(playerAnswer));
                const correctAns = Number(questionText.dataset.correctAnswer);
                const lastQIndex = questionHistory.length - 1;

                if (roundedPlayerAnswer === correctAns) {
                    currentCombo++;
                    timeLeft += 5;
                    const comboMultiplier = 1 + Math.min(currentCombo, 5) * 0.1;
                    const basePoints = 10;
                    const points = basePoints * comboMultiplier;
                    currentScore += Math.round(points);

                    document.getElementById('feedback-message').textContent = `âœ… ç­”å°äº†ï¼+${Math.round(points)}åˆ†, é€£æ“Š x ${comboMultiplier.toFixed(1)}ï¼Œæ™‚é–“+5ç§’ï¼`;
                    document.getElementById('feedback-message').className = 'feedback correct';

                    questionHistory[lastQIndex].playerAnswer = String(roundedPlayerAnswer);

                } else {
                    currentCombo = 0;
                    timeLeft -= 5;

                    document.getElementById('feedback-message').textContent = `âŒ ç­”éŒ¯äº†ï¼-5ç§’ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctAns}ã€‚`;
                    document.getElementById('feedback-message').className = 'feedback incorrect';

                    questionHistory[lastQIndex].playerAnswer = String(roundedPlayerAnswer);
                }

                scoreDisplay.textContent = `å¾—åˆ†: ${currentScore}`;
                comboDisplay.textContent = `é€£æ“Š: ${currentCombo}`;
                timerDisplay.textContent = `â³ ${timeLeft}s`;
                answerInput.value = '';

                setTimeout(() => {
                    document.getElementById('feedback-message').textContent = '';
                    if (timeLeft > 0) {
                        generateQuestion(currentLevel);
                    } else {
                        endGame();
                    }
                }, 1500);
            }

            function calculateStars(score) {
                if (score >= STAR_THRESHOLD[3]) return 3;
                if (score >= STAR_THRESHOLD[2]) return 2;
                if (score >= STAR_THRESHOLD[1]) return 1;
                return 0;
            }

            function endGame() {
                clearInterval(timerInterval);
                const finalStars = calculateStars(currentScore);
                const starSymbols = 'â˜…'.repeat(finalStars) + 'â˜†'.repeat(3 - finalStars);

                document.getElementById('final-player-name').textContent = playerName;
                document.getElementById('final-score').textContent = currentScore;
                document.getElementById('final-stars').textContent = starSymbols;
                document.getElementById('star-message').textContent = finalStars === 3 ? 'ğŸ‰ æ­å–œï¼ä¸‰é¡†æ˜Ÿå°ˆå®¶ï¼' : (finalStars > 0 ? 'è¡¨ç¾ä¸éŒ¯ï¼Œç¹¼çºŒæŒ‘æˆ°ï¼' : 'ä¸‹æ¬¡æœƒæ›´å¥½ï¼');

                const answerDisplay = document.getElementById('correct-answer-display');
                answerDisplay.innerHTML = '<h4>æœ¬å±€é¡Œç›®å›é¡§ï¼š</h4>';
                questionHistory.forEach((item, index) => {
                    const isCorrect = (item.playerAnswer === item.correct);
                    answerDisplay.innerHTML += `<p style="color: ${isCorrect ? 'green' : 'red'};">Q${index + 1}: ${item.question} | æ‚¨çš„ç­”æ¡ˆ: ${item.playerAnswer} | **æ­£ç¢ºç­”æ¡ˆ: ${item.correct}**</p>`;
                });

                updateLeaderboard(playerName, currentScore, finalStars);
                showView(resultModal);
            }

            function getLeaderboard() {
                try { return JSON.parse(localStorage.getItem('jessieMathAreaLeaderboard')) || []; } catch { return []; }
            }

            function updateLeaderboard(name, score, stars) {
                const leaderboard = getLeaderboard();
                leaderboard.push({ name, score, stars, date: new Date().toLocaleString(), level: currentLevel });
                leaderboard.sort((a, b) => b.score - a.score);
                const topTwenty = leaderboard.slice(0, 20);
                localStorage.setItem('jessieMathAreaLeaderboard', JSON.stringify(topTwenty));
                renderLeaderboard();
            }

            function renderLeaderboard() {
                const leaderboardList = document.getElementById('leaderboard-list');
                const data = getLeaderboard();
                if (!leaderboardList) return;

                leaderboardList.innerHTML = '';

                data.forEach((item, index) => {
                    const starSymbols = 'â˜…'.repeat(item.stars) + 'â˜†'.repeat(3 - item.stars);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>#${index + 1} ${item.name} (L${item.level})</span>
                        <span>${starSymbols} | **${item.score}** åˆ†</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });
            }

            // == äº‹ä»¶ç›£è½å™¨è¨­å®š ==

            document.getElementById('start-game-button').addEventListener('click', () => {
                playerName = playerNameInput.value.trim();

                if (playerName) {
                    showView(levelSelection);
                } else {
                    alert('è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼');
                }
            });

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });

            document.querySelectorAll('.level-card').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const level = parseInt(e.currentTarget.dataset.level);
                    if (!isNaN(level)) {
                       startGame(level);
                    }
                });
            });

            document.getElementById('show-leaderboard-btn').addEventListener('click', () => {
                renderLeaderboard();
                showView(leaderboardView);
            });

            document.getElementById('back-from-leaderboard').addEventListener('click', () => {
                showView(levelSelection);
            });

            document.getElementById('pause-button').addEventListener('click', togglePause);
            document.getElementById('resume-button').addEventListener('click', togglePause);
            document.getElementById('reset-button').addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹æœ¬é—œå¡å—ï¼Ÿåˆ†æ•¸å°‡æ­¸é›¶ã€‚')) {
                    startGame(currentLevel);
                }
            });
            document.getElementById('exit-button').addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦å›é—œå¡ä¸»é¸å–®å—ï¼Ÿæœ¬æ¬¡æˆç¸¾å°‡ä¸å¯«å…¥æ’è¡Œæ¦œã€‚')) {
                    clearInterval(timerInterval);
                    questionHistory = [];
                    showView(levelSelection);
                }
            });

            submitButton.addEventListener('click', () => {
                const answer = parseFloat(answerInput.value);
                if (!isNaN(answer)) { checkAnswer(answer); } else { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ç­”æ¡ˆï¼'); }
            });
            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { submitButton.click(); }
            });

            document.getElementById('back-to-select').addEventListener('click', () => {
                showView(levelSelection);
            });

            // åˆå§‹è¼‰å…¥ï¼šé¡¯ç¤ºèµ·å§‹é é¢
            showView(startModal);
        };
    </script>
</body>
</html>
